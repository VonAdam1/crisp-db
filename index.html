<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crisp Production Dashboard</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@0.292.0"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* Base styles */
        body { 
            font-family: 'Outfit', sans-serif; 
            background-color: #050505; 
            color: #f5f5f7; 
            margin: 0;
            min-height: 100vh;
            background: radial-gradient(circle at 50% 0%, #1c1c1e 0%, #000000 80%);
            -webkit-tap-highlight-color: transparent;
        }

        /* DESKTOP ONLY: Lock scrolling */
        @media (min-width: 768px) {
            body {
                overflow: hidden;
                height: 100vh;
            }
        }
        
        /* Premium Glass */
        .glass-card { 
            background: rgba(20, 20, 22, 0.7); 
            backdrop-filter: blur(50px); 
            -webkit-backdrop-filter: blur(50px);
            border: 1px solid rgba(255, 255, 255, 0.08); 
            box-shadow: 0 20px 50px -10px rgba(0, 0, 0, 0.5);
            border-radius: 1.5rem;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
        }

        /* Hover effects only on Desktop */
        @media (min-width: 768px) {
            .glass-card:hover {
                border-color: rgba(255, 255, 255, 0.2);
                box-shadow: 0 30px 80px -15px rgba(0, 0, 0, 0.7);
                z-index: 10;
                cursor: grab;
            }
            .glass-card:active {
                cursor: grabbing;
                transform: scale(0.99);
            }
        }

        .glass-card.dragging {
            opacity: 0.5;
            border: 2px dashed rgba(255,255,255,0.3);
            background: transparent;
            box-shadow: none;
            cursor: grabbing;
        }

        .resize-handle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 30px;
            height: 30px;
            cursor: nwse-resize;
            z-index: 50;
            opacity: 0;
            transition: opacity 0.2s;
            display: none; 
        }
        
        @media (min-width: 768px) {
            .resize-handle { display: block; }
            .glass-card:hover .resize-handle { opacity: 1; }
        }
        
        .resize-handle::after {
            content: '';
            position: absolute;
            bottom: 8px;
            right: 8px;
            width: 8px;
            height: 8px;
            border-bottom: 2px solid rgba(255,255,255,0.4);
            border-right: 2px solid rgba(255,255,255,0.4);
            border-radius: 1px;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .animate-in { animation: fadeIn 0.6s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- IKONER ---
        const createLucideIcon = (name) => {
            if (!window.lucide || !window.lucide.icons) return () => null;
            const iconData = window.lucide.icons[name];
            if (!iconData) return () => null;
            return ({ size = 24, className = "", color = "currentColor", ...props }) => {
                if (!Array.isArray(iconData)) return null;
                const [tag, defaultAttrs, children = []] = iconData;
                const toCamel = (s) => s.replace(/-([a-z])/g, (g) => g[1].toUpperCase());
                const processAttrs = (attrs) => {
                    const newAttrs = {};
                    for (const [k, v] of Object.entries(attrs || {})) {
                        const key = k === 'class' ? 'className' : toCamel(k);
                        newAttrs[key] = v;
                    }
                    return newAttrs;
                };
                const combinedAttrs = { ...processAttrs(defaultAttrs), width: size, height: size, stroke: color, className: `lucide lucide-${name.toLowerCase()} ${className}`, ...props };
                const childElements = Array.isArray(children) ? children.map(([childTag, childAttrs], idx) => React.createElement(childTag, { ...processAttrs(childAttrs), key: idx })) : [];
                return React.createElement(tag, combinedAttrs, ...childElements);
            };
        };

        const CloudRain = createLucideIcon('CloudRain');
        const Sun = createLucideIcon('Sun');
        const CloudSun = createLucideIcon('CloudSun');
        const CloudFog = createLucideIcon('CloudFog');
        const CloudSnow = createLucideIcon('CloudSnow');
        const CloudLightning = createLucideIcon('CloudLightning');
        const CheckSquare = createLucideIcon('CheckSquare');
        const Cake = createLucideIcon('Cake');
        const Wind = createLucideIcon('Wind');
        const Droplets = createLucideIcon('Droplets');
        const Video = createLucideIcon('Video');
        const Trophy = createLucideIcon('Trophy');
        const Calendar = createLucideIcon('Calendar');
        const MapPin = createLucideIcon('MapPin');
        const ArrowRight = createLucideIcon('ArrowRight');
        const PackageCheck = createLucideIcon('PackageCheck');
        const Star = createLucideIcon('Star');
        const Image = createLucideIcon('Image');
        const RefreshCw = createLucideIcon('RefreshCw');
        const PartyPopper = createLucideIcon('PartyPopper');
        const Thermometer = createLucideIcon('Thermometer');
        const Eye = createLucideIcon('Eye');
        const Move = createLucideIcon('Move');
        const Umbrella = createLucideIcon('Umbrella');

        // --- KONFIGURATION ---
        
        // HÃ„R KAN DU Ã„NDRA STORLEKAR (Tailwind klasser)
        const SIZE_CONFIG = {
            // Logotypens hÃ¶jd
            logoHeightMobile: "h-12",
            logoHeightDesktop: "h-25",
            
            // Klockans textstorlek
            clockSizeMobile: "text-6xl",
            clockSizeDesktop: "text-9xl",
            
            // Datumets textstorlek
            dateSizeMobile: "text-xl",
            dateSizeDesktop: "text-3xl",
            
            // VÃ¤der-temperatur textstorlek (Topp)
            weatherTempMobile: "text-6xl",
            weatherTempDesktop: "text-10xl",
            
            // "Going on at Crisp" rubrik (om logga saknas)
            headerTitleMobile: "text-4xl",
            headerTitleDesktop: "text-7xl"
        };

        const CLICKUP_API_TOKEN = "pk_206499020_MHKUBIAUIQI6N64DO4IMSVAYIEW3HKM9";
        const CLICKUP_SPACE_ID = "90155050040"; 
        const CLICKUP_BIRTHDAY_LIST_ID = "901517968972";
        const GOOGLE_SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTg2K8CukJPbpDaXCSFymNJK67nEIDcciuJSiy8xvibV1cziFBovc9mDPf9vmqyQceIEck6wfy0ly36/pub?gid=0&single=true&output=csv"; 
        const START_DATE_TIMESTAMP = new Date('2025-01-01').getTime();
        const CLICKUP_PROJECTS_LIST_ID = "901515357300";

        // LOGGOR
        const LOGO_SYMBOL = "./Crisp-Symbol-White.png";
        const LOGO_TEXT = "./Crisp_text-logo_white.png";

        // --- MODULER ---

        const WeatherModule = ({ data, loading, w, h }) => {
            let statusText = "Laddar...";
            if (!loading && !data) statusText = "Ingen data";
            if (data?.condition) statusText = data.condition;

            return (
                <div className="h-full flex flex-col relative overflow-hidden p-5 md:p-6">
                    <div className="absolute inset-0 bg-gradient-to-br from-blue-500/10 to-transparent pointer-events-none"></div>
                    
                    {/* TOP: Location & Current Status */}
                    <div className="relative z-10 flex justify-between items-start mb-2">
                         <div>
                            <div className="flex items-center gap-2 text-blue-300 text-xs font-bold uppercase tracking-widest mb-1">
                                <MapPin size={12} /> Stockholm
                            </div>
                            <div className="flex items-center gap-4">
                                <div className={`font-bold tracking-tighter text-white leading-none ${SIZE_CONFIG.weatherTempMobile} md:${SIZE_CONFIG.weatherTempDesktop}`}>
                                    {data?.temp !== undefined ? Math.round(data.temp) : "--"}Â°
                                </div>
                                <div className="flex flex-col">
                                     <div className="text-lg md:text-xl text-slate-200 font-bold leading-tight">{statusText}</div>
                                     <div className="flex items-center gap-2 text-xs text-slate-400 font-bold uppercase mt-1">
                                        {/* Wind now correctly in m/s from API */}
                                        <span className="flex items-center gap-1"><Wind size={12}/> {data?.wind ? Math.round(data.wind) : "-"} m/s</span>
                                     </div>
                                </div>
                            </div>
                        </div>
                        <div className="bg-white/5 rounded-full border border-white/10 shadow-xl p-3">
                             {data?.icon || <RefreshCw className="animate-spin text-slate-500" size={32} />}
                        </div>
                    </div>

                    {/* MIDDLE: Today's Timeline (Cleaner Design) */}
                    <div className="flex-grow flex flex-col justify-center py-2 relative z-10">
                        <div className="grid grid-cols-4 divide-x divide-white/10">
                            {data?.todayForecast?.map((item, i) => (
                                <div key={i} className="flex flex-col items-center justify-start pt-1 px-1 text-center h-full">
                                    <span className="text-slate-400 text-[9px] md:text-[10px] font-bold uppercase tracking-wide mb-1">{item.label}</span>
                                    
                                    {/* STÃ–RRE IKON och TEXT */}
                                    <div className="my-1 text-white">{item.icon}</div>
                                    <span className="text-[9px] uppercase text-blue-200 font-bold mb-1 truncate max-w-full px-1">{item.text}</span>
                                    
                                    <span className="text-white font-bold text-lg leading-none mb-1">{Math.round(item.temp)}Â°</span>
                                    
                                    <div className="flex flex-col gap-0.5 w-full items-center opacity-60 mt-auto pb-1">
                                        <div className="flex items-center gap-1 text-[9px]" title="Vindbyar">
                                            <Wind size={10} className="text-slate-300"/>
                                            <span>{Math.round(item.wind)}</span>
                                        </div>
                                        <div className="flex items-center gap-1 text-[9px]" title="NederbÃ¶rd">
                                            <Umbrella size={10} className="text-blue-300"/>
                                            <span>{item.rain}%</span>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* BOTTOM: Next Days Forecast (More Compact Cards) */}
                    <div className="pt-3 border-t border-white/10 relative z-10 mt-auto">
                        <div className="grid grid-cols-3 gap-3">
                            {data?.nextDays?.map((day, i) => (
                                <div key={i} className="flex flex-col items-center justify-center p-2 rounded-xl bg-white/5 border border-white/5 hover:bg-white/10 transition-colors">
                                    <span className="text-slate-400 text-xs font-bold uppercase mb-1">{day.day}</span>
                                    <div className="mb-1">{day.icon}</div>
                                    <span className="text-[9px] uppercase text-slate-400 font-bold mb-1">{day.text}</span>
                                    <span className="text-white font-bold text-sm">{Math.round(day.temp)}Â°</span>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const ProductionModule = ({ stats, recent, loading, h }) => {
            return (
                <div className="h-full p-6 md:p-8 flex flex-col gap-6 relative overflow-hidden">
                    <div className="flex items-center gap-3 mb-2">
                        <Trophy className="text-orange-400" size={32} />
                        <h2 className="text-xl md:text-2xl font-bold uppercase tracking-wide text-white">Produktion 2025</h2>
                    </div>

                    {/* Stats Grid */}
                    <div className="grid grid-cols-2 grid-rows-2 gap-4 shrink-0">
                        <div className="bg-slate-800/50 rounded-2xl p-4 border border-blue-500/20 flex flex-col items-center justify-center text-center">
                             <span className="text-3xl md:text-4xl font-black text-blue-400 tracking-tighter">{loading ? "-" : stats?.activeProjects}</span>
                             <span className="text-[10px] font-bold text-slate-400 uppercase mt-1 tracking-widest">IgÃ¥ng Nu</span>
                        </div>
                        <div className="bg-slate-800/50 rounded-2xl p-4 border border-purple-500/20 flex flex-col items-center justify-center text-center">
                             <span className="text-3xl md:text-4xl font-black text-purple-400 tracking-tighter">{loading ? "-" : stats?.totalProjects2025}</span>
                             <span className="text-[10px] font-bold text-slate-400 uppercase mt-1 tracking-widest">Totalt 2025</span>
                        </div>

                        <div className="bg-slate-800/50 rounded-2xl p-4 border border-emerald-500/20 flex flex-col items-center justify-center text-center">
                             <span className="text-3xl md:text-4xl font-black text-emerald-400 tracking-tighter">{loading ? "-" : stats?.year}</span>
                             <span className="text-[10px] font-bold text-slate-400 uppercase mt-1 tracking-widest">Lev. Tasks</span>
                        </div>
                        <div className="bg-slate-800/50 rounded-2xl p-4 border border-orange-500/20 flex flex-col items-center justify-center text-center">
                             <span className="text-3xl md:text-4xl font-black text-orange-400 tracking-tighter">{loading ? "-" : stats?.occasions}</span>
                             <span className="text-[10px] font-bold text-slate-400 uppercase mt-1 tracking-widest">Insp. Dagar</span>
                        </div>
                    </div>

                    {/* Recent List */}
                    <div className="flex-grow flex flex-col min-h-0 animate-in pt-4 border-t border-white/5">
                        <div className="flex items-center gap-3 mb-4 text-emerald-400 mt-2">
                            <PackageCheck size={18} />
                            <h3 className="text-xs font-bold uppercase tracking-widest">Nyligen Levererat</h3>
                        </div>
                        <div className="space-y-2 overflow-y-auto no-scrollbar flex-grow">
                            {recent?.length > 0 ? recent.slice(0, 6).map((del, i) => (
                                <div key={i} className="flex justify-between items-center p-3 rounded-xl bg-white/5 border border-white/5">
                                    <span className="text-white font-medium text-sm truncate mr-2">{del.name}</span>
                                    <span className="text-[10px] font-bold text-emerald-400 uppercase tracking-wider bg-emerald-500/10 px-2 py-1 rounded">{del.date}</span>
                                </div>
                            )) : <p className="text-sm text-slate-500 italic">Inget nyligen.</p>}
                        </div>
                    </div>
                </div>
            );
        };

        const BirthdaysModule = ({ birthdays }) => (
             <div className="h-full p-6 md:p-8 flex flex-col">
                <div className="flex items-center gap-3 mb-6 text-pink-400">
                    <PartyPopper size={28} />
                    <h3 className="text-lg md:text-xl font-bold uppercase tracking-widest text-white">Fyller Ã¥r (30 dagar)</h3>
                </div>
                <div className="space-y-4 overflow-y-auto no-scrollbar flex-grow">
                    {birthdays?.length > 0 ? birthdays.map((b, i) => (
                        <div key={i} className="flex items-center gap-5 p-4 rounded-2xl bg-white/5 hover:bg-white/10 transition-colors border border-white/5">
                            <div className="w-12 h-12 md:w-14 md:h-14 rounded-full bg-gradient-to-br from-pink-500 to-purple-600 flex items-center justify-center text-white text-lg md:text-xl font-bold shadow-lg shrink-0">
                                {b.name.charAt(0)}
                            </div>
                            <div>
                                <div className="text-white text-xl md:text-2xl font-bold">{b.name}</div>
                                <div className="text-pink-300 text-sm md:text-base font-bold uppercase tracking-wide mt-0.5">{b.dateStr} {b.isSoon && "ðŸŽ‚"}</div>
                            </div>
                        </div>
                    )) : <div className="h-full flex items-center justify-center text-slate-500 text-sm italic">Inga fÃ¶delsedagar nÃ¤ra.</div>}
                </div>
             </div>
        );

        const SlideshowModule = () => {
            const [index, setIndex] = useState(0);
            const [validImages, setValidImages] = useState([]);
            
            useEffect(() => {
                const possibleImages = [];
                for (let i = 1; i <= 20; i++) {
                    possibleImages.push(`bilder/${i}.jpg`);
                    possibleImages.push(`bilder/${i}.png`);
                    possibleImages.push(`bilder/${i}.jpeg`);
                }
                setValidImages(possibleImages);
            }, []);

            useEffect(() => {
                if (validImages.length === 0) return;
                const timer = setInterval(() => setIndex((prev) => (prev + 1) % validImages.length), 8000);
                return () => clearInterval(timer);
            }, [validImages]);

            const handleImageError = (badSrc) => {
                setValidImages(prev => prev.filter(src => src !== badSrc));
            };

            const currentImage = validImages[index];

            return (
                <div className="h-full w-full relative group overflow-hidden rounded-[2rem] bg-black cursor-grab active:cursor-grabbing flex items-center justify-center">
                    {validImages.length > 0 ? (
                        <>
                            {validImages.map((img, i) => (
                                <img 
                                    key={img}
                                    src={img}
                                    onError={() => handleImageError(img)}
                                    className="absolute inset-0 w-full h-full object-cover object-center transition-opacity duration-1000 ease-in-out"
                                    style={{ 
                                        opacity: index === i ? 1 : 0,
                                        transform: index === i ? 'scale(1)' : 'scale(1.05)',
                                        transition: 'opacity 1s ease-in-out, transform 8s ease-out'
                                    }}
                                    alt="Life at Crisp"
                                />
                            ))}
                             <div className="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent"></div>
                             <div className="absolute bottom-8 left-8 pointer-events-none">
                                 <div className="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-white/10 backdrop-blur-md border border-white/10 text-xs font-bold uppercase tracking-widest text-white mb-2">
                                    <Image size={14} /> Life at Crisp
                                </div>
                                <h2 className="text-3xl md:text-4xl font-bold text-white tracking-tight">Creating Magic</h2>
                            </div>
                        </>
                    ) : (
                        <div className="h-full flex flex-col items-center justify-center text-slate-600">
                            <Image size={48} />
                            <p className="mt-4 font-medium">LÃ¤gg bilder i mappen "bilder"</p>
                            <p className="text-xs opacity-50">(1.jpg, 2.png, etc)</p>
                        </div>
                    )}
                </div>
            );
        };

        const TimelineModule = ({ items, loading }) => (
            <div className="h-full p-6 md:p-8 flex flex-col">
                <div className="flex items-center justify-between mb-8">
                    <h2 className="text-2xl md:text-3xl font-bold text-white tracking-tight">HÃ¤nder FramÃ¶ver</h2>
                    {loading && <RefreshCw className="animate-spin text-slate-600" size={24}/>}
                </div>
                <div className="flex-grow space-y-4 overflow-y-auto no-scrollbar pr-2">
                    {items.length > 0 ? items.map((item, idx) => {
                         const isRec = item.type === 'recording';
                         return (
                            <div key={idx} className="flex items-center gap-5 md:gap-6 p-4 md:p-5 bg-white/5 rounded-3xl border border-white/5 transition-all hover:bg-white/10">
                                <div className={`flex flex-col items-center justify-center w-16 h-16 md:w-20 md:h-20 rounded-2xl shrink-0 ${isRec ? 'bg-red-500/20 text-red-400' : 'bg-indigo-500/20 text-indigo-400'}`}>
                                    <span className="font-bold text-2xl md:text-3xl leading-none">{item.dateMain}</span>
                                    <span className="text-[10px] md:text-xs font-bold uppercase mt-0.5">{item.dateSub}</span>
                                </div>
                                <div className="flex-grow min-w-0">
                                    <h3 className="text-lg md:text-2xl font-semibold text-white truncate leading-tight">{item.title}</h3>
                                    <div className="flex items-center gap-3 mt-1.5">
                                         {isRec ? <Video size={16} className="text-red-400"/> : <Star size={16} className="text-indigo-400"/>}
                                         <span className="text-xs md:text-base font-bold uppercase tracking-wider text-slate-400">{item.subtitle}</span>
                                    </div>
                                </div>
                            </div>
                         );
                    }) : (
                        <div className="h-full flex flex-col items-center justify-center text-slate-600 opacity-50">
                            <Calendar size={64} strokeWidth={1} />
                            <p className="mt-4 text-xl font-medium">Kalendern Ã¤r tom</p>
                        </div>
                    )}
                </div>
            </div>
        );

        // --- GRID APP COMPONENT ---

        const App = () => {
            const [time, setTime] = useState(new Date());
            const [data, setData] = useState(null);
            const [weather, setWeather] = useState(null);
            const [loading, setLoading] = useState(true);

            // INITIAL LAYOUT
            const [modules, setModules] = useState([
                { id: 'weather',    colSpan: 8, rowSpan: 2, component: 'WeatherModule' }, 
                { id: 'birthdays',  colSpan: 4, rowSpan: 2, component: 'BirthdaysModule' },
                { id: 'production', colSpan: 12, rowSpan: 3, component: 'ProductionModule' }, 
                { id: 'timeline',   colSpan: 12, rowSpan: 3, component: 'TimelineModule' },
                { id: 'slideshow',  colSpan: 12, rowSpan: 2, component: 'SlideshowModule' },
            ]);

            const [draggedId, setDraggedId] = useState(null);
            const [resizingId, setResizingId] = useState(null);

            // --- Drag & Drop (Only for Desktop) ---
            const onDragStart = (e, id) => {
                // Ignore if screen is small (mobile)
                if (window.innerWidth < 768) return; 
                if (resizingId) { e.preventDefault(); return; }
                setDraggedId(id);
                e.dataTransfer.effectAllowed = "move";
                e.currentTarget.classList.add('dragging');
            };

            const onDragEnd = (e) => {
                setDraggedId(null);
                e.currentTarget.classList.remove('dragging');
            };

            const onDrop = (targetId) => {
                if (window.innerWidth < 768) return;
                if (!draggedId || draggedId === targetId) return;
                const newModules = [...modules];
                const dIdx = newModules.findIndex(m => m.id === draggedId);
                const tIdx = newModules.findIndex(m => m.id === targetId);
                const temp = newModules[dIdx];
                newModules.splice(dIdx, 1);
                newModules.splice(tIdx, 0, temp);
                setModules(newModules);
                setDraggedId(null);
            };

            // --- Resize (Only for Desktop) ---
            const handleResizeStart = (e, id) => {
                if (window.innerWidth < 768) return;
                e.preventDefault();
                e.stopPropagation();
                setResizingId(id);
                const startX = e.clientX;
                const startY = e.clientY;
                const moduleIdx = modules.findIndex(m => m.id === id);
                const startCol = modules[moduleIdx].colSpan;
                const startRow = modules[moduleIdx].rowSpan;

                const gridWidth = window.innerWidth - 64; 
                const cellWidth = gridWidth / 12; 
                const cellHeight = 160 + 24; 

                const onMouseMove = (moveEvent) => {
                    const dx = moveEvent.clientX - startX;
                    const dy = moveEvent.clientY - startY;
                    const colChange = Math.round(dx / cellWidth);
                    const rowChange = Math.round(dy / cellHeight);

                    if (colChange !== 0 || rowChange !== 0) {
                        setModules(prev => {
                            const next = [...prev];
                            const m = next[moduleIdx];
                            const newCol = Math.max(3, Math.min(12, startCol + colChange));
                            const newRow = Math.max(1, Math.min(6, startRow + rowChange));
                            if (m.colSpan !== newCol || m.rowSpan !== newRow) {
                                next[moduleIdx] = { ...m, colSpan: newCol, rowSpan: newRow };
                                return next;
                            }
                            return prev;
                        });
                    }
                };

                const onMouseUp = () => {
                    setResizingId(null);
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                };

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            };

            const renderModuleContent = (mod) => {
                 const allUpcoming = [
                    ...(data?.events || []).map(e => ({ ...e, type: 'event', title: e.name, subtitle: 'Event' })),
                    ...(data?.recordings || []).map(r => ({ ...r, type: 'recording', title: r.project, subtitle: 'Inspelning' }))
                ].sort((a, b) => a.sortDate - b.sortDate).slice(0, 8); 

                switch(mod.component) {
                    case 'WeatherModule': return <WeatherModule data={weather} loading={loading} w={mod.colSpan} h={mod.rowSpan} />;
                    case 'ProductionModule': return <ProductionModule stats={data?.stats} recent={data?.recentDeliveries} loading={loading} h={mod.rowSpan} />;
                    case 'SlideshowModule': return <SlideshowModule />;
                    case 'TimelineModule': return <TimelineModule items={allUpcoming} loading={loading} />;
                    case 'BirthdaysModule': return <BirthdaysModule birthdays={data?.birthdays} />;
                    default: return null;
                }
            };

            useEffect(() => {
                const timer = setInterval(() => setTime(new Date()), 1000);
                const fetchData = async () => {
                    setLoading(true);
                    
                    try {
                        const clickUpData = await getClickUpData();
                        const sheetData = await getGoogleSheetEvents();
                        const weatherData = await getRealWeather();
                        setData({ ...clickUpData, events: sheetData });
                        setWeather(weatherData);
                    } catch(e) {}
                    setLoading(false);
                };
                
                fetchData();

                const interval = setInterval(() => {
                    const now = new Date();
                    const m = now.getMinutes();
                    // UPPDATERA VARJE HEL TIMME (NÃ¤r minutvisaren Ã¤r pÃ¥ 0)
                    if (m === 0) {
                        console.log("Uppdaterar data (hel timme)...");
                        fetchData();
                    }
                }, 60000); // Kollar varje minut

                return () => { clearInterval(timer); clearInterval(interval); };
            }, []);

            const timeStr = time.toLocaleTimeString('sv-SE', { hour: '2-digit', minute: '2-digit' });
            const dateStr = time.toLocaleDateString('sv-SE', { weekday: 'long', day: 'numeric', month: 'long' });

            return (
                <div className="min-h-screen p-4 md:p-8 flex flex-col md:h-screen bg-[#050505] overflow-y-auto md:overflow-hidden">
                    <header className="flex flex-col md:flex-row justify-between items-center md:items-end mb-8 px-2 md:px-4 pt-2 animate-in shrink-0 z-50 pointer-events-none h-auto md:h-[160px] text-center md:text-left">
                         <div className="flex flex-col items-center md:items-start w-full md:w-auto">
                             {/* LOGGOR HÃ„R */}
                             <div className="flex items-center gap-4 mb-3">
                                <img 
                                    src={LOGO_SYMBOL} 
                                    alt="Crisp" 
                                    className={`${SIZE_CONFIG.logoHeightMobile} md:${SIZE_CONFIG.logoHeightDesktop} w-auto object-contain`}
                                    onError={(e) => e.target.style.display = 'none'}
                                />
                                <img 
                                    src={LOGO_TEXT} 
                                    alt="Crisp Film" 
                                    className="h-6 md:h-8 w-auto object-contain mt-2" 
                                    onError={(e) => e.target.style.display = 'none'}
                                />
                             </div>
                             {/* Fallback text if logos miss */}
                             <div className="hidden">
                                <h1 className={`${SIZE_CONFIG.headerTitleMobile} md:${SIZE_CONFIG.headerTitleDesktop} font-bold tracking-tighter text-white leading-none mb-2`}>Going on at Crisp</h1>
                            </div>
                            <p className="text-slate-400 text-lg md:text-2xl font-medium tracking-wide uppercase opacity-80">We make brands stronger through film</p>
                        </div>
                        <div className="w-full md:w-auto flex flex-col items-center md:items-end mt-6 md:mt-0">
                            <div className={`${SIZE_CONFIG.clockSizeMobile} md:${SIZE_CONFIG.clockSizeDesktop} font-semibold text-white tracking-tighter leading-none`}>{timeStr}</div>
                            <div className={`text-slate-400 ${SIZE_CONFIG.dateSizeMobile} md:${SIZE_CONFIG.dateSizeDesktop} capitalize font-medium mt-2`}>{dateStr}</div>
                        </div>
                    </header>

                    {/* BENTO GRID */}
                    {/* On mobile: grid-cols-1, auto-rows. On Desktop: grid-cols-12, fixed rows */}
                    <div className="grid grid-cols-1 md:grid-cols-12 auto-rows-auto md:auto-rows-[160px] gap-4 md:gap-6 flex-grow pb-6 grid-flow-dense relative z-10">
                        {modules.map((mod) => (
                            <div 
                                key={mod.id}
                                draggable={!resizingId} 
                                onDragStart={(e) => onDragStart(e, mod.id)}
                                onDragEnd={onDragEnd}
                                onDragOver={(e) => e.preventDefault()}
                                onDrop={() => onDrop(mod.id)}
                                className={`
                                    glass-card animate-in 
                                    col-span-1 md:col-span-${mod.colSpan} 
                                    md:row-span-${mod.rowSpan} 
                                    min-h-[350px] md:min-h-0
                                    ${draggedId === mod.id ? 'dragging' : ''} 
                                    ${resizingId === mod.id ? 'resizing' : ''}
                                `}
                            >
                                {renderModuleContent(mod)}
                                
                                <div 
                                    className="resize-handle"
                                    onMouseDown={(e) => handleResizeStart(e, mod.id)}
                                    title="Dra fÃ¶r att Ã¤ndra storlek"
                                ></div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- REAL WEATHER API ---
        async function getRealWeather() {
            try {
                // Stockholm Coords
                const lat = 59.3293;
                const lon = 18.0686;
                // FIX: remove 'time' from daily variables to prevent 400 Bad Request
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code,wind_speed_10m&hourly=temperature_2m,weather_code,wind_speed_10m,precipitation_probability&daily=weather_code,temperature_2m_max&timezone=auto&forecast_days=4&wind_speed_unit=ms`;
                
                const res = await fetch(url);
                if (!res.ok) {
                    console.error("Weather API Error:", res.status, res.statusText);
                    throw new Error("API Response not OK");
                }

                const json = await res.json();
                
                if (!json?.current || !json?.hourly?.time || !json?.daily?.time) {
                    throw new Error("Invalid API Data Structure");
                }

                const current = json.current;
                const hourly = json.hourly;
                const daily = json.daily;
                
                const getWeatherIcon = (code, size=56, isYellow=false) => {
                    if (code === 0) return <Sun size={size} className={isYellow ? "text-yellow-400" : "text-white"} />;
                    if (code <= 3) return <CloudSun size={size} className="text-blue-300" />;
                    if (code <= 48) return <CloudFog size={size} className="text-slate-400" />;
                    if (code <= 67 || (code >= 80 && code <= 82)) return <CloudRain size={size} className="text-blue-400" />;
                    if (code <= 77 || code === 85 || code === 86) return <CloudSnow size={size} className="text-white" />;
                    return <CloudLightning size={size} className="text-purple-400" />;
                };

                const getWeatherText = (code) => {
                    if (code === 0) return "Soligt";
                    if (code <= 3) return "Molnigt";
                    if (code <= 48) return "Dimmigt";
                    if (code <= 67) return "Regn";
                    if (code <= 77) return "SnÃ¶";
                    if (code >= 80 && code <= 82) return "Skurar";
                    return "OvÃ¤der";
                };

                const getHourlyVal = (key, idx) => {
                    return hourly[key] && hourly[key][idx] !== undefined ? hourly[key][idx] : 0;
                };

                const indices = [8, 12, 16, 20];
                const labels = ["Morgon", "Lunch", "Eftermiddag", "KvÃ¤ll"];
                
                const todayForecast = indices.map((idx, i) => {
                    const code = getHourlyVal('weather_code', idx);
                    const temp = getHourlyVal('temperature_2m', idx);
                    const wind = getHourlyVal('wind_speed_10m', idx);
                    const rain = getHourlyVal('precipitation_probability', idx);
                    
                    return {
                        label: labels[i],
                        icon: getWeatherIcon(code, 40, code === 0), // Increased size
                        text: getWeatherText(code),
                        temp: temp,
                        wind: wind,
                        rain: rain
                    };
                });
                
                const nextDays = daily.time.slice(1, 4).map((t, i) => {
                    const date = new Date(t);
                    const dayName = date.toLocaleDateString('sv-SE', {weekday:'short'}).replace('.',''); 
                    
                    const dailyCode = daily.weather_code[i+1];
                    const dailyTemp = daily.temperature_2m_max[i+1];
                    
                    return {
                        day: dayName,
                        icon: getWeatherIcon(dailyCode, 32, dailyCode === 0), // Increased size
                        text: getWeatherText(dailyCode),
                        temp: dailyTemp
                    };
                });

                return {
                    temp: current.temperature_2m,
                    condition: getWeatherText(current.weather_code),
                    wind: current.wind_speed_10m,
                    icon: getWeatherIcon(current.weather_code, 40, current.weather_code === 0),
                    todayForecast: todayForecast,
                    nextDays: nextDays
                };

            } catch(e) {
                console.error("Weather Error Details:", e);
                return null;
            }
        }

        // --- API ---
        async function getGoogleSheetEvents() {
            if (!GOOGLE_SHEET_CSV_URL) return [];
            try {
                const url = `${GOOGLE_SHEET_CSV_URL}&t=${Date.now()}`;
                const res = await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`);
                if (!res.ok) return [];
                const txt = await res.text();
                const rows = txt.split(/\r\n|\n/);
                const events = [];
                const yest = new Date(); yest.setDate(yest.getDate()-1); yest.setHours(0,0,0,0);
                const parseDateRobustly = (dateStr) => {
                    if (!dateStr) return null;
                    let cleanStr = dateStr.trim();
                    let d = new Date(cleanStr);
                    if (!isNaN(d.getTime())) return d;
                    cleanStr = cleanStr.split(' ')[0];
                    d = new Date(cleanStr);
                    if (!isNaN(d.getTime())) return d;
                    const parts = cleanStr.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})/);
                    if (parts) return new Date(`${parts[3]}-${parts[2]}-${parts[1]}`);
                    return null;
                };
                rows.forEach((row, i) => {
                    if(i===0) return;
                    const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                    if(cols.length < 4) return;
                    const name = cols[2].replace(/^"|"$/g, '').trim();
                    const dateStr = cols[3].replace(/^"|"$/g, '').trim();
                    if(name && dateStr) {
                        const d = parseDateRobustly(dateStr);
                        if(d && d >= yest) {
                            events.push({
                                name, sortDate: d.getTime(),
                                dateMain: d.getDate(),
                                dateSub: d.toLocaleDateString('sv-SE', {month:'short'}).toUpperCase()
                            });
                        }
                    }
                });
                return events;
            } catch(e) { return []; }
        }

        async function getClickUpData() {
            if (!CLICKUP_SPACE_ID) return {};
            const headers = { 'Authorization': CLICKUP_API_TOKEN };
            const proxy = "https://corsproxy.io/?";
            try {
                const teamRes = await fetch(`${proxy}https://api.clickup.com/api/v2/team`, { headers });
                const teamId = (await teamRes.json()).teams[0].id;
                
                const getAllTasks = async (archived) => {
                    let all = []; let page = 0;
                    while(page < 40) {
                        try {
                            const url = `${proxy}https://api.clickup.com/api/v2/team/${teamId}/task?space_ids[]=${CLICKUP_SPACE_ID}&archived=${archived}&include_closed=true&subtasks=true&limit=100&date_updated_gt=${START_DATE_TIMESTAMP}&page=${page}`;
                            const res = await fetch(url, { headers });
                            const json = await res.json();
                            if(!json.tasks || json.tasks.length === 0) break;
                            all = [...all, ...json.tasks];
                            page++;
                        } catch(e) { break; }
                    }
                    return all;
                };

                const getProjectTasks = async () => {
                    let all = []; let page = 0;
                    if (!CLICKUP_PROJECTS_LIST_ID) return [];
                    while(page < 5) {
                         try {
                            const url = `${proxy}https://api.clickup.com/api/v2/list/${CLICKUP_PROJECTS_LIST_ID}/task?include_closed=true&date_updated_gt=${START_DATE_TIMESTAMP}&page=${page}`;
                            const res = await fetch(url, { headers });
                            const json = await res.json();
                            if(!json.tasks || json.tasks.length === 0) break;
                            all = [...all, ...json.tasks];
                            page++;
                         } catch(e) { break; }
                    }
                    return all;
                };

                const [active, archived, projects] = await Promise.all([
                    getAllTasks(false), 
                    getAllTasks(true),
                    getProjectTasks()
                ]);

                const tasksMap = new Map(); [...active, ...archived].forEach(t => tasksMap.set(t.id, t));
                let tasks = Array.from(tasksMap.values()).filter(t => {
                     const folderName = t.folder ? t.folder.name : "";
                     const listName = t.list ? t.list.name : "";
                     return folderName.startsWith("25") || listName.startsWith("25");
                });

                const validProjects = projects.filter(t => t.name.startsWith("25"));
                const activeProjects = validProjects.filter(t => t.status.status.toLowerCase() === 'production').length;
                const totalProjects2025 = validProjects.filter(t => {
                    const s = t.status.status.toLowerCase();
                    return s === 'production' || s === 'delivered';
                }).length;

                const recTasks = tasks.filter(t => t.name.trim().toLowerCase() === "inspelning");
                const upcomingRec = recTasks
                    .filter(t => {
                        const d = parseInt(t.start_date||t.due_date||0);
                        const s = t.status.status.toLowerCase();
                        return d >= Date.now() - 86400000 && s!=='complete' && s!=='closed' && s!=='klar' && s!=='done';
                    })
                    .sort((a,b) => (a.start_date||0) - (b.start_date||0));
                const seen = new Set(); const finalRec = [];
                for(const t of upcomingRec) {
                    let n = "Projekt";
                    if(t.folder) n = t.folder.name; else if(t.list) n = t.list.name;
                    n = n.length > 6 && n.includes('_') ? n.substring(6).replace(/_/g,' ') : n;
                    if(!seen.has(n)) {
                        seen.add(n);
                        const d = parseInt(t.start_date||t.due_date);
                        finalRec.push({
                            id: t.id, project: n, sortDate: d,
                            dateMain: new Date(d).getDate(),
                            dateSub: new Date(d).toLocaleDateString('sv-SE',{month:'short'}).toUpperCase()
                        });
                    }
                    if(finalRec.length >= 5) break;
                }

                const delTasks = tasks.filter(t => {
                    const n = t.name.toLowerCase();
                    const s = t.status.status.toLowerCase();
                    return n.includes("leverans") && !n.includes("inspelning") && (s==='complete'||s==='closed'||s==='done'||s==='klar');
                });
                const recentDel = delTasks
                    .sort((a,b) => parseInt(b.date_closed||0) - parseInt(a.date_closed||0))
                    .slice(0,5)
                    .map(t => {
                        let n = "Projekt";
                        if(t.folder) n = t.folder.name; else if(t.list) n = t.list.name;
                        n = n.length > 6 && n.includes('_') ? n.substring(6).replace(/_/g,' ') : n;
                        const ts = parseInt(t.date_closed||t.date_updated||0);
                        return { name: n, date: ts > 0 ? new Date(ts).toLocaleDateString('sv-SE',{day:'numeric', month:'short'}) : "-" };
                    });
                let birthdays = [];
                if(CLICKUP_BIRTHDAY_LIST_ID) {
                     try {
                        const bdRes = await fetch(`${proxy}https://api.clickup.com/api/v2/list/${CLICKUP_BIRTHDAY_LIST_ID}/task`, { headers });
                        const bdJson = await bdRes.json();
                        birthdays = (bdJson.tasks || [])
                            .map(t => {
                                const d = new Date(parseInt(t.due_date));
                                const today = new Date();
                                let next = new Date(today.getFullYear(), d.getMonth(), d.getDate());
                                if(next < today) next.setFullYear(today.getFullYear()+1);
                                const diff = Math.ceil((next - today)/(1000*60*60*24));
                                return { name: t.name, dateStr: next.toLocaleDateString('sv-SE', {day:'numeric', month:'short'}), diff, isSoon: diff < 14 };
                            })
                            .filter(b => b.diff < 40)
                            .sort((a,b) => a.diff - b.diff)
                            .slice(0,3);
                    } catch(e) {}
                }
                return {
                    stats: { 
                        year: delTasks.length, 
                        occasions: recTasks.length,
                        activeProjects: activeProjects,
                        totalProjects2025: totalProjects2025
                    },
                    recordings: finalRec,
                    recentDeliveries: recentDel,
                    birthdays: birthdays
                };
            } catch(e) { return {}; }
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>