<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>v2)</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@0.292.0"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { 
            font-family: 'Outfit', sans-serif; 
            background-color: #050505; 
            color: #f5f5f7; 
            margin: 0;
            min-height: 100vh;
            background: radial-gradient(circle at 50% 0%, #1c1c1e 0%, #000000 80%);
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }
        
        .glass-card { 
            background: rgba(20, 20, 22, 0.7); 
            backdrop-filter: blur(50px); -webkit-backdrop-filter: blur(50px);
            border: 1px solid rgba(255, 255, 255, 0.08); 
            box-shadow: 0 20px 50px -10px rgba(0, 0, 0, 0.5);
            border-radius: 1.5rem;
            overflow: hidden; display: flex; flex-direction: column; position: relative;
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
            -webkit-mask-image: -webkit-radial-gradient(white, black);
        }
        
        @media (min-width: 768px) {
            .glass-card:hover { border-color: rgba(255, 255, 255, 0.2); box-shadow: 0 30px 80px -15px rgba(0, 0, 0, 0.7); z-index: 10; cursor: grab; }
            .glass-card:active { cursor: grabbing; transform: scale(0.99); }
        }
        
        .transparent-container {
            background: transparent;
            border: none;
            box-shadow: none;
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            overflow: visible;
        }
        
        .glass-card.dragging { opacity: 0.5; border: 2px dashed rgba(255,255,255,0.3); background: transparent; box-shadow: none; cursor: grabbing; }
        .resize-handle { position: absolute; bottom: 0; right: 0; width: 30px; height: 30px; cursor: nwse-resize; z-index: 50; opacity: 0; transition: opacity 0.2s; display: none; }
        @media (min-width: 768px) { .resize-handle { display: block; } .glass-card:hover .resize-handle { opacity: 1; } }
        .resize-handle::after { content: ''; position: absolute; bottom: 8px; right: 8px; width: 8px; height: 8px; border-bottom: 2px solid rgba(255,255,255,0.4); border-right: 2px solid rgba(255,255,255,0.4); border-radius: 1px; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .animate-in { animation: fadeIn 0.6s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 100; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        
        .gpu-accelerate { transform: translateZ(0); backface-visibility: hidden; }

        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- 1. CONFIGURATION ---
        const DASHBOARD_CONFIG = {
            slideshowInterval: 8000,
            design: {
                logoSymbolHeightMobile: "h-12", logoSymbolHeightDesktop: "h-16", 
                logoTextHeightMobile: "h-6", logoTextHeightDesktop: "h-8",     
                clockSizeMobile: "text-5xl", clockSizeDesktop: "text-7xl", 
                dateSizeMobile: "text-lg", dateSizeDesktop: "text-2xl",
            }
        };

        const API_CONFIG = {
            clickUpToken: "pk_206499020_MHKUBIAUIQI6N64DO4IMSVAYIEW3HKM9",
            clickUpSpaceId: "90155050040", 
            clickUpBirthdayListId: "901517968972", 
            clickUpProjectsListId: "901515357300",
            clickUpBudgetFieldId: "26f92511-130b-4909-a6e5-b51385752454",
            googleSheetCsvUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTg2K8CukJPbpDaXCSFymNJK67nEIDcciuJSiy8xvibV1cziFBovc9mDPf9vmqyQceIEck6wfy0ly36/pub?gid=0&single=true&output=csv",
            googleSheetTextUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSJwWMDbKsaGDlpxRustDgIzsaygyBFSJURPdKoPVpInMIzxDlHPKElmkcSC-4A9zQDBejWd-r5Jw-i/pub?output=csv",
            calendars: [
                { name: "Konferensrum", cid: "crispfilm.se_7lejdhj9e5qn2ebbf1qvt6icrk@group.calendar.google.com", color: "text-purple-400", bg: "bg-purple-500/10" },
                { name: "Onlinerum", cid: "c_5e0eb5196df089999b11010f2fa7d8cc220159894f90a3188543cd20c4802ea5@group.calendar.google.com", color: "text-blue-400", bg: "bg-blue-500/10" }
            ]
        };

        const LOGO_TEXT = "./Crisp_text-logo_white.png";
        const LOGO_SYMBOL = "./Crisp_symbol.png"; 

        // --- 2. ICONS ---
        const createLucideIcon = (name) => {
            if (!window.lucide || !window.lucide.icons) return () => null;
            const iconData = window.lucide.icons[name];
            return ({ size = 24, className = "", color = "currentColor", ...props }) => {
                const [tag, defaultAttrs, children = []] = iconData;
                const toCamel = (s) => s.replace(/-([a-z])/g, (g) => g[1].toUpperCase());
                const processAttrs = (attrs) => Object.entries(attrs || {}).reduce((acc, [k, v]) => ({ ...acc, [k==='class'?'className':toCamel(k)]: v }), {});
                return React.createElement(tag, { ...processAttrs(defaultAttrs), width: size, height: size, stroke: color, className: `lucide lucide-${name.toLowerCase()} ${className}`, ...props }, 
                    children.map(([t, a], i) => React.createElement(t, { ...processAttrs(a), key: i })));
            };
        };

        const CloudRain = createLucideIcon('CloudRain'); const Sun = createLucideIcon('Sun'); const CloudSun = createLucideIcon('CloudSun'); const CloudFog = createLucideIcon('CloudFog');
        const CloudSnow = createLucideIcon('CloudSnow'); const CloudLightning = createLucideIcon('CloudLightning'); const Wind = createLucideIcon('Wind'); const Video = createLucideIcon('Video');
        const Trophy = createLucideIcon('Trophy'); const Calendar = createLucideIcon('Calendar'); const MapPin = createLucideIcon('MapPin'); const PackageCheck = createLucideIcon('PackageCheck');
        const Star = createLucideIcon('Star'); const Image = createLucideIcon('Image'); const PartyPopper = createLucideIcon('PartyPopper'); const Umbrella = createLucideIcon('Umbrella');
        const Loader2 = createLucideIcon('Loader2'); const HelpCircle = createLucideIcon('HelpCircle'); const X = createLucideIcon('X');
        const User = createLucideIcon('User'); const Bell = createLucideIcon('Bell'); const Gift = createLucideIcon('Gift');
        const Users = createLucideIcon('Users'); const DoorOpen = createLucideIcon('DoorOpen'); const RotateCcw = createLucideIcon('RotateCcw');
        const Settings = createLucideIcon('Settings');
        const Target = createLucideIcon('Target');
        const Moon = createLucideIcon('Moon');

        // --- 3. DATA HELPERS ---
        
        // 1. NAMNSDAGAR (Via Vercel Rewrite)
        const getNamnsdagar = async () => {
            try {
                // Anropar din lokala Vercel-väg istället för extern URL direkt
                const res = await fetch('/api/holiday/');
                if (!res.ok) throw new Error("API Error");
                const data = await res.json();
                const names = data.dagar[0]?.namnsdag || [];
                return names.length > 0 ? names.join(', ') : "Inga namnsdagar";
            } catch(e) { return "Hämtar..."; }
        };
        
        // 2. VÄDER (Direkt, funkar utan proxy)
        const getRealWeather = async () => { 
            try { 
                const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=59.3293&longitude=18.0686&current=temperature_2m,weather_code,wind_speed_10m&hourly=temperature_2m,weather_code,wind_speed_10m,precipitation_probability&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=auto&forecast_days=4&wind_speed_unit=ms`); 
                if (!r.ok) throw new Error("API Err"); 
                const j = await r.json(); 
                const { current, hourly, daily } = j; 
                const getIcon = (c, s, y) => { 
                    const P = { size: s, className: y ? "text-yellow-400" : "text-white" }; 
                    const C = { size: s, className: "text-blue-300" }; 
                    if(c===0) return <Sun {...P}/>; if(c<=3) return <CloudSun {...C}/>; if(c<=48) return <CloudFog size={s} className="text-slate-400"/>; if(c<=67||(c>=80&&c<=82)) return <CloudRain size={s} className="text-blue-400"/>; if(c<=77||c===85) return <CloudSnow size={s} className="text-white"/>; return <CloudLightning size={s} className="text-purple-400"/>; 
                }; 
                const getText = (c) => c===0?"Soligt":c<=3?"Molnigt":c<=48?"Dimmigt":c<=67?"Regn":c<=77?"Snö":c>=80?"Skurar":"Oväder"; 
                const todayForecast = [8,12,16,20].map((idx, i) => ({ label: ["Morgon","Lunch","Eftermiddag","Kväll"][i], icon: getIcon(hourly.weather_code[idx], 40, hourly.weather_code[idx]===0), text: getText(hourly.weather_code[idx]), temp: hourly.temperature_2m[idx], wind: hourly.wind_speed_10m[idx], rain: hourly.precipitation_probability[idx] })); 
                const nextDays = daily.time.slice(1,4).map((t,i) => ({ day: new Date(t).toLocaleDateString('sv-SE',{weekday:'short'}).replace('.',''), icon: getIcon(daily.weather_code[i+1],32,daily.weather_code[i+1]===0), text: getText(daily.weather_code[i+1]), temp: daily.temperature_2m_max[i+1] })); 
                return { temp: current.temperature_2m, minTemp: daily.temperature_2m_min[0], condition: getText(current.weather_code), wind: current.wind_speed_10m, icon: getIcon(current.weather_code, 40, current.weather_code===0), todayForecast, nextDays }; 
            } catch(e) { return null; } 
        };
        
        // 3. GOOGLE SHEETS EVENTS (Via Vercel Rewrite)
        const getGoogleSheetEvents = async () => { 
            if (!API_CONFIG.googleSheetCsvUrl) return []; 
            try { 
                // Vi strippar domänen och behåller bara path för rewriten
                const cleanPath = API_CONFIG.googleSheetCsvUrl.replace('https://docs.google.com', '');
                // Lägg till tidsstämpel för att undvika cache
                const url = `/api/sheets${cleanPath}&t=${Date.now()}`;
                
                const res = await fetch(url); 
                if (!res.ok) return []; 
                const rows = (await res.text()).split(/\r\n|\n/); 
                const events = []; 
                const yest = new Date(); yest.setDate(yest.getDate()-1); yest.setHours(0,0,0,0); 
                const parseDateRobustly = (dateStr) => {
                    if (!dateStr) return null;
                    const cleanStr = dateStr.trim().split(' ')[0];
                    let d = new Date(cleanStr);
                    if (!isNaN(d.getTime())) return d;
                    const parts = cleanStr.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})/);
                    if (parts) { d = new Date(`${parts[3]}-${parts[2]}-${parts[1]}`); if (!isNaN(d.getTime())) return d; }
                    return null;
                };
                rows.forEach((row, i) => { 
                    if(i===0) return; 
                    const c = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/); 
                    if(c.length>=4){ 
                        const n = c[2].replace(/^"|"$/g,'').trim(); 
                        const ds = c[3].replace(/^"|"$/g,'').trim(); 
                        let timeLabel = "";
                        const tStart = c[4] ? c[4].replace(/^"|"$/g,'').trim() : "";
                        const tEnd = c.length > 6 && c[6] ? c[6].replace(/^"|"$/g,'').trim() : "";
                        if(tStart && tEnd) timeLabel = `${tStart} - ${tEnd}`; else if(tStart) timeLabel = tStart; else if(tEnd) timeLabel = tEnd;
                        const d = parseDateRobustly(ds);
                        if(d && d>=yest) { events.push({ name:n, sortDate:d.getTime(), dateMain:d.getDate(), dateSub:d.toLocaleDateString('sv-SE',{month:'short'}).toUpperCase(), timeStr: timeLabel }); }
                    } 
                }); 
                return events; 
            } catch(e) { console.error("Sheet error", e); return []; } 
        };

        // 4. GOOGLE SHEETS MOTTO (Via Vercel Rewrite)
        const getGoogleSheetMotto = async () => {
            if (!API_CONFIG.googleSheetTextUrl) return null;
            try {
                const cleanPath = API_CONFIG.googleSheetTextUrl.replace('https://docs.google.com', '');
                const uniqueParam = `nocache=${Date.now()}_${Math.floor(Math.random() * 100000)}`;
                const url = `/api/sheets${cleanPath}&${uniqueParam}`;
                
                const res = await fetch(url, { cache: 'no-store', headers: { 'Pragma': 'no-cache', 'Cache-Control': 'no-cache' } });
                if (!res.ok) return null;
                const textData = await res.text();
                
                const parseCSV = (str) => {
                    const arr = []; let quote = false; let row = 0, col = 0;
                    for (let c = 0; c < str.length; c++) {
                        let cc = str[c], nc = str[c+1];
                        arr[row] = arr[row] || []; arr[row][col] = arr[row][col] || '';
                        if (cc == '"' && quote && nc == '"') { arr[row][col] += cc; ++c; }
                        else if (cc == '"') { quote = !quote; }
                        else if (cc == ',' && !quote) { ++col; }
                        else if (cc == '\r' && nc == '\n' && !quote) { ++row; col = 0; ++c; }
                        else if (cc == '\n' && !quote) { ++row; col = 0; }
                        else if (cc == '\r' && !quote) { ++row; col = 0; }
                        else { arr[row][col] += cc; }
                    }
                    return arr;
                };
                const rows = parseCSV(textData);
                let title = "Every frame counts"; let shouldReload = "FALSE"; 
                if (rows.length > 0) {
                    if (rows[0].length > 0) { const a1Text = rows[0][0]; const cleanText = a1Text ? a1Text.trim() : ""; if (cleanText.length > 0) title = cleanText; }
                    if (rows[0].length > 1) { const b1Text = rows[0][1]; if (b1Text && b1Text.trim().toUpperCase() === "RELOAD") shouldReload = "RELOAD"; }
                }
                return { title: title, subtitle: "Life at Crisp", shouldReload: shouldReload };
            } catch (e) { return null; }
        };

        // 5. KALENDER (Via Vercel Rewrite)
        const getRoomBookings = async () => {
            if (!API_CONFIG.calendars) return [];
            let allBookings = [];
            const parseICSDate = (str) => {
                if(!str) return null;
                const year = str.substring(0, 4); const month = str.substring(4, 6) - 1; const day = str.substring(6, 8);
                const hour = str.length > 8 ? str.substring(9, 11) : 0; const min = str.length > 8 ? str.substring(11, 13) : 0;
                return new Date(Date.UTC(year, month, day, hour, min, 0));
            };
            for (const cal of API_CONFIG.calendars) {
                try {
                    // Vi använder vår egen tunnel
                    const url = `/api/calendar/calendar/ical/${cal.cid}/public/basic.ics`;
                    const res = await fetch(url);
                    if (!res.ok) continue;
                    const text = await res.text();
                    const eventRegex = /BEGIN:VEVENT([\s\S]*?)END:VEVENT/g;
                    let match;
                    const now = new Date();
                    const cutoff = new Date(now.getTime() - 60*60*1000); 
                    while ((match = eventRegex.exec(text)) !== null) {
                        const eventBlock = match[1];
                        const getField = (field) => { const r = new RegExp(`${field}[:;](.*)`); const m = eventBlock.match(r); return m ? m[1].trim() : null; };
                        let dtStart = getField('DTSTART');
                        if (dtStart && dtStart.includes('VALUE=DATE')) dtStart = dtStart.split(':')[1];
                        let dtEnd = getField('DTEND');
                        if (dtEnd && dtEnd.includes('VALUE=DATE')) dtEnd = dtEnd.split(':')[1];
                        const summary = getField('SUMMARY') || "Bokat";
                        if (dtStart) {
                            const startDate = parseICSDate(dtStart);
                            const endDate = dtEnd ? parseICSDate(dtEnd) : null;
                            if (startDate >= cutoff) {
                                const isToday = startDate.getDate() === now.getDate() && startDate.getMonth() === now.getMonth();
                                const timeStr = isToday ? `${startDate.getHours().toString().padStart(2,'0')}:${startDate.getMinutes().toString().padStart(2,'0')}${endDate ? ' - ' + endDate.getHours().toString().padStart(2,'0') + ':' + endDate.getMinutes().toString().padStart(2,'0') : ''}` : startDate.toLocaleDateString('sv-SE', {weekday:'short', day:'numeric', month:'short'}) + ` ${startDate.getHours().toString().padStart(2,'0')}:${startDate.getMinutes().toString().padStart(2,'0')}`;
                                allBookings.push({ roomName: cal.name, roomColor: cal.color, roomBg: cal.bg, title: summary.replace(/\\/g, ''), time: timeStr, dateObj: startDate, attendees: "" });
                            }
                        }
                    }
                } catch (e) { }
            }
            return allBookings.sort((a,b) => a.dateObj - b.dateObj).slice(0, 10);
        };

        // 6. CLICKUP - FÖDELSEDAGAR (Via Vercel Rewrite)
        const getClickUpBirthdays = async () => { 
            if (!API_CONFIG.clickUpBirthdayListId) return []; 
            try { 
                // Ingen proxy-url, bara vår lokala /api/clickup/...
                const url = `/api/clickup/list/${API_CONFIG.clickUpBirthdayListId}/task`;
                const r = await fetch(url, { headers: { 'Authorization': API_CONFIG.clickUpToken } }); 
                return (await r.json()).tasks.map(t => { 
                    const d = new Date(parseInt(t.due_date)); const today = new Date(); let next = new Date(today.getFullYear(), d.getMonth(), d.getDate()); 
                    if(next<today) next.setFullYear(today.getFullYear()+1); const diff = Math.ceil((next-today)/(86400000)); 
                    return { name: t.name, dateStr: next.toLocaleDateString('sv-SE',{day:'numeric',month:'short'}), diff, isSoon: diff<14 }; 
                }).filter(b=>b.diff<40).sort((a,b)=>a.diff-b.diff).slice(0,3); 
            } catch(e) { return []; } 
        };

        // 7. CLICKUP - PRODUKTIONSDATA (Via Vercel Rewrite)
        const getClickUpProductionData = async (targetYear) => {
            if (!API_CONFIG.clickUpSpaceId) return {};
            const headers = { 'Authorization': API_CONFIG.clickUpToken };
            
            try {
                // Hämta Team ID via tunneln
                const tRes = await fetch(`/api/clickup/team`, { headers }); const teamId = (await tRes.json()).teams[0].id;
                const startTimestamp = new Date("2023-01-01").getTime(); 
                
                // Notera hur vi nu anropar /api/clickup istället för https://api.clickup.com
                const getTasks = async (archived) => { let all = []; let p = 0; while(p < 30) { try { const res = await fetch(`/api/clickup/team/${teamId}/task?space_ids[]=${API_CONFIG.clickUpSpaceId}&archived=${archived}&include_closed=true&subtasks=true&limit=100&date_updated_gt=${startTimestamp}&page=${p}`, { headers }); const j = await res.json(); if(!j.tasks || j.tasks.length===0) break; all.push(...j.tasks); p++; } catch(e) { break; } } return all; };
                const getProj = async () => { if (!API_CONFIG.clickUpProjectsListId) return []; let all = []; let p = 0; while(p < 5) { try { const res = await fetch(`/api/clickup/list/${API_CONFIG.clickUpProjectsListId}/task?include_closed=true&date_updated_gt=${startTimestamp}&page=${p}`, { headers }); const j = await res.json(); if(!j.tasks || j.tasks.length===0) break; all.push(...j.tasks); p++; } catch(e) { break; } } return all; };

                const [active, archived, projects] = await Promise.all([getTasks(false), getTasks(true), getProj()]);
                const tasks = [...active, ...archived];
                
                const shortYear = targetYear.slice(-2); 
                const fullYear = targetYear;

                const listActive = []; const listTotal = []; const listDelivered = []; const listDeliveredMonth = []; 
                const listSales = []; 
                const listSold = []; 
                const listRec = []; const listStream = []; const listVO = [];

                let activeBudget = 0; let deliveredBudget = 0; let totalBudget = 0; let monthDeliveredBudget = 0;
                let salesBudget = 0; 
                let soldBudget = 0; 
                const budgetFieldId = API_CONFIG.clickUpBudgetFieldId;
                
                const validProjects = projects.filter(t => t.name.startsWith(shortYear) || t.name.startsWith(fullYear));
                const now = new Date(); const currentMonth = now.getMonth(); const currentYearNum = now.getFullYear();

                validProjects.forEach(t => {
                    const s = t.status.status.toLowerCase();
                    let budget = 0;
                    if(t.custom_fields) { const bf = t.custom_fields.find(f => f.id === budgetFieldId); if(bf && bf.value) budget = parseFloat(bf.value) || 0; }
                    const item = { name: t.name, status: s, folder: "Project Hub", budget: budget };
                    
                    if(s.includes('sales') || s.includes('sälj')) {
                        listSales.push(item);
                        salesBudget += budget;
                    }
                    
                    if(s === 'done' || s === 'stängd' || s === 'closed' || s === 'won' || s === 'ej landad') {
                        listSold.push(item);
                        soldBudget += budget;
                    }

                    if(s === 'production') { listActive.push(item); listTotal.push(item); activeBudget += budget; totalBudget += budget; }
                    if(s === 'delivered') {
                        const d = parseInt(t.date_closed||t.date_updated||0);
                        const dateObj = new Date(d);
                        const delItem = { ...item, date: d > 0 ? dateObj.toLocaleDateString('sv-SE',{day:'numeric',month:'short'}) : '-' };
                        listDelivered.push(delItem); listTotal.push(delItem); deliveredBudget += budget; totalBudget += budget;
                        if (d > 0 && dateObj.getMonth() === currentMonth && dateObj.getFullYear() === currentYearNum) { listDeliveredMonth.push(delItem); monthDeliveredBudget += budget; }
                    }
                });
                
                listDelivered.sort((a, b) => a.name.localeCompare(b.name, 'sv'));

                let recCount = 0; let streamCount = 0; let voCount = 0; const upcomingRecs = [];
                const ignoreWords = ["genomgång", "brief", "planering", "förberedelse", "casting", "check", "koll", "recce", "schema", "annons", "annonser"];

                tasks.forEach(t => {
                    const fName = t.folder ? t.folder.name : ""; const lName = t.list ? t.list.name : "";
                    const isTargetYear = fName.includes(shortYear) || lName.includes(shortYear) || fName.includes(fullYear) || lName.includes(fullYear);
                    const is24185 = (fName.startsWith("24185") || lName.startsWith("24185")) && targetYear === '2025';

                    if (!isTargetYear && !is24185) return;

                    const listNameClean = lName.toLowerCase();
                    if (!listNameClean.includes('production') && !listNameClean.includes('stream') && !listNameClean.includes('live') && !listNameClean.includes('studio')) return; 
                    const name = t.name;
                    if (ignoreWords.some(w => name.toLowerCase().includes(w))) return; 
                    const isVO = /\b(VO|Röst|Voiceover)\b/i.test(name);
                    const isStream = /\b(Stream)\b/i.test(name);
                    const isRec = /\b(Inspelning)\b/i.test(name);
                    
                    if (is24185 && !isStream) return;
                    const status = t.status.status.toLowerCase();
                    const isDone = ['complete', 'closed', 'klar', 'done'].includes(status);

                    if (isDone) {
                        const displayFolder = fName || lName;
                        const item = { name: t.name, status: status, folder: displayFolder };
                        if (isVO) { voCount++; listVO.push({ ...item, type: 'VO' }); } else if (isStream) { streamCount++; listStream.push({ ...item, type: 'Stream' }); } else if (isRec) { recCount++; listRec.push({ ...item, type: 'Inspelning' }); }
                    }
                    if ((isVO || isStream || isRec) && !isDone) {
                        const start = parseInt(t.start_date);
                        const due = parseInt(t.due_date);
                        
                        let datesToAdd = [];
                        
                        if (start && due && due > start) {
                            let curr = new Date(start);
                            const end = new Date(due);
                            while (curr <= end && datesToAdd.length < 30) {
                                datesToAdd.push(curr.getTime());
                                curr.setDate(curr.getDate() + 1);
                            }
                        } else {
                            datesToAdd.push(start || due || 0);
                        }

                        datesToAdd.forEach(d => {
                            if (d >= Date.now() - 86400000) {
                                let pName = t.folder ? t.folder.name : (t.list ? t.list.name : "Projekt");
                                if(pName.length>6 && pName.includes('_')) pName = pName.substring(6).replace(/_/g,' ');
                                upcomingRecs.push({ 
                                    id: t.id, 
                                    project: pName, 
                                    sortDate: d, 
                                    dateMain: new Date(d).getDate(), 
                                    dateSub: new Date(d).toLocaleDateString('sv-SE',{month:'short'}).toUpperCase(), 
                                    isStream: isStream, 
                                    isVO: isVO 
                                });
                            }
                        });
                    }
                });

                const uniqueRecs = []; const seen = new Set();
                upcomingRecs.sort((a,b) => a.sortDate - b.sortDate);
                for(const r of upcomingRecs) { 
                    const key = r.project + "_" + r.dateMain + "_" + r.dateSub;
                    if(!seen.has(key)) { 
                        seen.add(key); 
                        uniqueRecs.push(r); 
                    } 
                    if(uniqueRecs.length>=15) break; 
                }

                const recentDelSidebar = validProjects.filter(t => t.status.status.toLowerCase() === 'delivered').sort((a,b) => parseInt(b.date_closed||b.date_updated||0) - parseInt(a.date_closed||a.date_updated||0)).slice(0,20).map(t => ({ name: t.name, date: new Date(parseInt(t.date_closed||t.date_updated)).toLocaleDateString('sv-SE',{day:'numeric', month:'short'}) }));

                return { 
                    stats: { 
                        year: listDelivered.length, monthDelivered: listDeliveredMonth.length, occasions: recCount, streams: streamCount, vos: voCount, activeProjects: listActive.length, totalProjectsCurrentYear: listTotal.length, salesCount: listSales.length, soldCount: listSold.length,
                        budgetActive: activeBudget, budgetDelivered: deliveredBudget, budgetMonth: monthDeliveredBudget, budgetTotal: totalBudget, budgetSales: salesBudget, budgetSold: soldBudget,
                        lists: { active: listActive, total: listTotal, delivered: listDelivered, deliveredMonth: listDeliveredMonth, rec: listRec, stream: listStream, vo: listVO, sales: listSales, sold: listSold }
                    }, 
                    recordings: uniqueRecs, recentDeliveries: recentDelSidebar 
                };
            } catch(e) { return {}; }
        };

        const WeatherModule = ({ data, loading }) => {
            if (loading) return (
                <div className="h-full flex items-center justify-center">
                    <Loader2 className="animate-spin text-slate-600" size={32} />
                </div>
            );
            if (!data) return <div className="h-full flex items-center justify-center text-slate-500">Väderdata saknas</div>;

            return (
                <div className="h-full p-6 flex flex-col justify-between">
                    <div className="flex justify-between items-start">
                        <div>
                            <div className="text-5xl font-bold text-white leading-none">{Math.round(data.temp)}°</div>
                            <div className="text-slate-400 font-medium mt-1">{data.condition}</div>
                        </div>
                        <div className="text-blue-400">{data.icon}</div>
                    </div>
                    
                    <div className="grid grid-cols-4 gap-2 mt-4 pt-4 border-t border-white/5">
                        {data.todayForecast.map((f, i) => (
                            <div key={i} className="flex flex-col items-center">
                                <span className="text-[10px] text-slate-500 font-bold uppercase">{f.label}</span>
                                <div className="scale-75 my-1">{f.icon}</div>
                                <span className="text-xs font-bold text-white">{Math.round(f.temp)}°</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const HeaderWeather = ({ weather, loading }) => {
            if (loading) return <div className="flex items-center gap-2 text-slate-500 text-xs"><Loader2 size={12} className="animate-spin"/> Hämtar väder...</div>;
            if (!weather) return <div className="text-slate-500 text-xs">Väder saknas</div>;

            return (
                <div className="flex flex-col items-end gap-0.5">
                    <div className="flex items-center gap-2">
                        <span className="text-2xl font-bold text-white leading-none">{Math.round(weather.temp)}°</span>
                        <div className="text-blue-300 scale-90">{weather.icon}</div>
                    </div>
                    <div className="flex items-center gap-1.5 text-xs font-bold text-slate-400 uppercase tracking-wide">
                        <span>STHLM</span>
                        <span>•</span>
                        <span className="flex items-center gap-1"><Moon size={10} className="text-slate-500"/> {Math.round(weather.minTemp)}°</span>
                    </div>
                </div>
            );
        };

        const HeaderInfoModule = ({ nameDays, birthdays }) => (
            <div className="flex flex-col items-center md:items-end gap-3 w-full">
                <div className="flex flex-col items-end gap-1 w-full">
                    <div className="flex items-center justify-end gap-2 text-right">
                        <div className="text-xs font-bold text-slate-400 uppercase tracking-widest">Namnsdag</div>
                        <div className="text-sm font-bold text-white">{nameDays || "..."}</div>
                    </div>
                    
                    <div className="flex flex-col items-end gap-1 mt-1">
                        <div className="flex items-center justify-end gap-2 text-right">
                                <div className="text-xs font-bold text-slate-400 uppercase tracking-widest flex items-center gap-1"><Gift size={12} className="text-pink-400"/> Födelsedagar</div>
                        </div>

                        {birthdays && birthdays.length > 0 ? (
                            <div className="flex flex-wrap justify-center md:justify-end gap-2">
                                {birthdays.map((b, i) => (
                                    <div key={i} className="flex items-center gap-1.5 bg-white/5 px-2 py-1 rounded-lg border border-white/10">
                                        <span className="text-pink-400 font-bold text-[10px] uppercase">{b.dateStr}</span>
                                        <span className="text-white font-bold text-xs">{b.name.split(' ')[0]}</span>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <div className="text-[10px] text-slate-500 italic">Inga födelsedagar nära</div>
                        )}
                    </div>
                </div>
            </div>
        );

        const ProductionModule = ({ stats, recent, loading, showRevenue, year, onOpenDetails }) => {
            const formatMoney = (amount) => {
                if (!amount) return "0 kr";
                return amount.toLocaleString('sv-SE') + " kr";
            };
            const currentMonthShort = new Date().toLocaleDateString('sv-SE', { month: 'short' }).toUpperCase().replace('.', '');

            return (
                <div className="h-full p-4 md:p-6 flex flex-col gap-4 relative overflow-hidden">
                    <div className="flex items-center justify-between mb-1">
                        <div className="flex items-center gap-2">
                            <Trophy className="text-orange-400" size={28} />
                            <h2 className={`text-xl md:text-2xl font-bold uppercase tracking-wide text-white`}>Produktion {year}</h2>
                        </div>
                        {loading && <Loader2 className="animate-spin text-slate-600" size={20} />}
                    </div>
                    
                    <div className="grid grid-cols-2 md:grid-cols-6 gap-4 shrink-0">
                        {/* ROW 1 */}
                        <div onClick={() => onOpenDetails('Aktiva projekt', stats?.lists?.active)} className="col-span-1 md:col-span-2 bg-slate-800/50 rounded-xl p-3 border border-blue-500/20 flex flex-col items-center justify-center text-center hover:bg-slate-800/80 cursor-pointer transition-colors relative">
                             <span className={`text-2xl md:text-3xl font-black text-blue-400 tracking-tighter ${loading ? 'opacity-50' : ''}`}>{loading ? "-" : stats?.activeProjects}</span>
                             <span className="text-[9px] font-bold text-slate-400 uppercase mt-1 tracking-widest">Aktiva projekt</span>
                             {!loading && showRevenue && <div className="text-[10px] md:text-xs font-mono text-emerald-300/80 mt-1 font-bold">{formatMoney(stats?.budgetActive)}</div>}
                        </div>
                         <div onClick={() => onOpenDetails(`Levererat (${currentMonthShort})`, stats?.lists?.deliveredMonth)} className="col-span-1 md:col-span-2 bg-slate-800/50 rounded-xl p-3 border border-emerald-500/20 flex flex-col items-center justify-center text-center hover:bg-slate-800/80 cursor-pointer transition-colors relative">
                             <span className={`text-2xl md:text-3xl font-black text-emerald-300 tracking-tighter ${loading ? 'opacity-50' : ''}`}>{loading ? "-" : stats?.monthDelivered}</span>
                             <span className="text-[9px] font-bold text-slate-400 uppercase mt-1 tracking-widest">Levererat ({currentMonthShort})</span>
                             {!loading && showRevenue && <div className="text-[10px] md:text-xs font-mono text-emerald-300 mt-1 font-bold shadow-black drop-shadow-md">{formatMoney(stats?.budgetMonth)}</div>}
                        </div>
                        <div onClick={() => onOpenDetails('Levererat (År)', stats?.lists?.delivered)} className="col-span-1 md:col-span-2 bg-slate-800/50 rounded-xl p-3 border border-emerald-500/10 flex flex-col items-center justify-center text-center hover:bg-slate-800/80 cursor-pointer transition-colors relative">
                             <span className={`text-2xl md:text-3xl font-black text-emerald-600 tracking-tighter ${loading ? 'opacity-50' : ''}`}>{loading ? "-" : stats?.year}</span>
                             <span className="text-[9px] font-bold text-slate-400 uppercase mt-1 tracking-widest">Levererat (År)</span>
                             {!loading && showRevenue && <div className="text-[10px] md:text-xs font-mono text-emerald-700 mt-1 font-bold">{formatMoney(stats?.budgetDelivered)}</div>}
                        </div>
                        
                        {/* ROW 2 */}
                        <div onClick={() => onOpenDetails('Sälj / Pipeline', stats?.lists?.sales)} className="col-span-1 md:col-span-2 bg-slate-800/50 rounded-xl p-3 border border-pink-500/20 flex flex-col items-center justify-center text-center hover:bg-slate-800/80 cursor-pointer transition-colors relative">
                             <span className={`text-2xl md:text-3xl font-black text-pink-400 tracking-tighter ${loading ? 'opacity-50' : ''}`}>{loading ? "-" : stats?.salesCount}</span>
                             <span className="text-[9px] font-bold text-slate-500 uppercase mt-1 tracking-widest">Sälj (Pipeline)</span>
                             {!loading && showRevenue && <div className="text-[10px] md:text-xs font-mono text-pink-300/80 font-bold mt-1">{formatMoney(stats?.budgetSales)}</div>}
                             
                             {/* Sold Section */}
                             <div className="mt-2 pt-2 border-t border-white/10 w-full flex flex-col items-center" onClick={(e) => { e.stopPropagation(); onOpenDetails('Insålda Projekt', stats?.lists?.sold); }}>
                                 <span className={`text-xl font-bold text-green-400 tracking-tight leading-none ${loading ? 'opacity-50' : ''}`}>{loading ? "-" : stats?.soldCount}</span>
                                 <span className="text-[8px] font-bold text-slate-500 uppercase tracking-widest">Insålda</span>
                                 {!loading && showRevenue && <div className="text-[9px] font-mono text-green-300/80 font-bold">{formatMoney(stats?.budgetSold)}</div>}
                             </div>
                        </div>

                        <div onClick={() => onOpenDetails('Totalt antal projekt', stats?.lists?.total)} className="col-span-1 md:col-span-2 bg-slate-800/50 rounded-xl p-3 border border-purple-500/20 flex flex-col items-center justify-center text-center hover:bg-slate-800/80 cursor-pointer transition-colors relative">
                             <span className={`text-3xl md:text-4xl font-black text-purple-400 tracking-tighter ${loading ? 'opacity-50' : ''}`}>{year}</span>
                             <div className="flex flex-col items-center mt-0.5 gap-0.5">
                                 <span className="text-sm md:text-base font-bold text-white leading-none">
                                     {loading ? "-" : stats?.totalProjectsCurrentYear} <span className="text-[10px] font-normal text-slate-400 uppercase">st</span>
                                 </span>
                                 {!loading && showRevenue && <div className="text-[10px] md:text-xs font-mono text-emerald-300/80 font-bold">{formatMoney(stats?.budgetTotal)}</div>}
                             </div>
                             <span className="text-[9px] font-bold text-slate-500 uppercase mt-1.5 tracking-widest">Totalt Helår</span>
                        </div>
                        <div onClick={() => onOpenDetails('Antal inspelningar', [...(stats?.lists?.rec||[]), ...(stats?.lists?.stream||[]), ...(stats?.lists?.vo||[])])} className="col-span-1 md:col-span-2 bg-slate-800/50 rounded-xl p-3 border border-orange-500/20 flex flex-col items-center justify-center text-center hover:bg-slate-800/80 cursor-pointer transition-colors">
                             <span className={`text-2xl md:text-3xl font-black text-orange-400 tracking-tighter ${loading ? 'opacity-50' : ''}`}>{loading ? "-" : stats?.occasions}</span>
                             <div className="flex items-center justify-center gap-2 mt-1 flex-wrap">
                                 <span className="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Antal inspelningar</span>
                                 {!loading && <span className="text-[8px] font-bold text-orange-200 uppercase whitespace-nowrap tracking-wider">(+ {stats?.streams || 0} Streams)</span>}
                                 {!loading && stats?.vos > 0 && <span className="text-[8px] font-bold text-orange-200 uppercase whitespace-nowrap tracking-wider">(+ {stats.vos} VO)</span>}
                             </div>
                        </div>
                    </div>
                    <div className="flex-grow flex flex-col min-h-0 animate-in pt-3 border-t border-white/5">
                        <div className="flex items-center gap-3 mb-3 text-emerald-400 mt-2"><PackageCheck size={16} /><h3 className="text-xs font-bold uppercase tracking-widest">Nyligen Levererat</h3></div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-2 overflow-y-auto no-scrollbar flex-grow content-start">
                            {loading ? <div className="col-span-2 space-y-2"><div className="h-8 bg-white/5 rounded-lg animate-pulse"></div><div className="h-8 bg-white/5 rounded-lg animate-pulse"></div></div> : recent?.length > 0 ? recent.slice(0, 20).map((del, i) => (
                                <div key={i} className="flex justify-between items-center p-2 rounded-lg bg-white/5 border border-white/5"><span className="text-white font-medium text-sm truncate mr-2">{del.name}</span><span className="text-[9px] font-bold text-emerald-400 uppercase tracking-wider bg-emerald-500/10 px-2 py-1 rounded">{del.date}</span></div>
                            )) : <p className="col-span-2 text-sm text-slate-500 italic">Inget nyligen.</p>}
                        </div>
                    </div>
                </div>
            );
        };

        const SlideshowModule = ({ customText }) => {
            const [index, setIndex] = useState(0); const [validImages, setValidImages] = useState([]);
            useEffect(() => { const arr = []; for (let i=1; i<=20; i++) { arr.push(`bilder/${i}.jpg`); arr.push(`bilder/${i}.png`); arr.push(`bilder/${i}.jpeg`); } setValidImages(arr); }, []);
            useEffect(() => { if (validImages.length === 0) return; const t = setInterval(() => setIndex((p) => (p + 1) % validImages.length), DASHBOARD_CONFIG.slideshowInterval); return () => clearInterval(t); }, [validImages]);
            const err = (s) => setValidImages(p => p.filter(x => x !== s));
            
            return (
                <div className="h-full w-full relative group bg-black flex items-center justify-center">
                    {/* Render text overlay independently */}
                    <div className="absolute bottom-6 left-6 pointer-events-none z-20">
                         {customText.subtitle && <div className="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-white/10 backdrop-blur-md border border-white/10 text-xs font-bold uppercase tracking-widest text-white mb-2"><Image size={12} /> {customText.subtitle}</div>}
                        <h2 className="text-2xl md:text-3xl font-bold text-white tracking-tight">{customText.title}</h2>
                    </div>

                    {validImages.length > 0 ? <React.Fragment>
                            {validImages.map((img, i) => (
                                // Use a dual-layer approach for dynamic filling without cropping important content
                                <React.Fragment key={img}>
                                    {/* Layer 1: Background Blur (Fill the box) */}
                                    <img 
                                        src={img} 
                                        className="absolute inset-0 w-full h-full object-cover blur-xl opacity-50 scale-110" 
                                        style={{ opacity: index === i ? 0.5 : 0, transition: 'opacity 1.5s ease-in-out' }} 
                                        alt="" 
                                    />
                                    {/* Layer 2: Main Image (Contain within box) */}
                                    <img 
                                        src={img} 
                                        onError={() => err(img)} 
                                        className="absolute inset-0 w-full h-full object-contain drop-shadow-2xl" 
                                        style={{ opacity: index === i ? 1 : 0, transition: 'opacity 1.5s ease-in-out', willChange: 'opacity' }} 
                                        alt="Crisp" 
                                    />
                                </React.Fragment>
                            ))}
                            <div className="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent pointer-events-none"></div>
                        </React.Fragment> : (
                            <div className="h-full flex flex-col items-center justify-center text-slate-600">
                                <Image size={48} />
                                <p className="mt-4 font-medium">Lägg bilder i mappen "bilder"</p>
                            </div>
                        )}
                </div>
            );
        };

        const TimelineModule = ({ items, bookings, loading }) => {
            const [width, setWidth] = useState(0); const ref = useRef(null);
            useEffect(() => { if (!ref.current) return; const ro = new ResizeObserver(entries => { if (entries[0]) setWidth(entries[0].contentRect.width); }); ro.observe(ref.current); return () => ro.disconnect(); }, []);
            const konfBookings = bookings ? bookings.filter(b => b.roomName === 'Konferensrum') : [];
            const onlineBookings = bookings ? bookings.filter(b => b.roomName === 'Onlinerum') : [];

            const renderList = (list, emptyText) => (
                <div className="flex-grow space-y-1.5 overflow-y-auto no-scrollbar pr-2 min-h-[100px]">
                    {loading && (!bookings || bookings.length === 0) ? <div className="space-y-2">{[1,2].map(i => <div key={i} className="h-12 bg-white/5 rounded-xl animate-pulse"></div>)}</div>
                    : list.length > 0 ? list.map((b, idx) => (
                        <div key={idx} className="flex items-start gap-3 p-2 bg-white/5 rounded-xl border border-white/5 hover:bg-white/10">
                            <div className={`mt-1 p-1.5 rounded-lg shrink-0 ${b.roomColor} ${b.roomBg}`}>
                                <DoorOpen size={14} />
                            </div>
                            <div className="min-w-0 flex-grow">
                                <div className="flex justify-between items-baseline">
                                    <span className="text-[10px] text-slate-500 font-bold">{b.time}</span>
                                </div>
                                <div className="font-semibold text-white text-sm truncate leading-tight mt-0.5">{b.title}</div>
                                {b.attendees && <div className="text-[10px] text-slate-400 mt-0.5 truncate flex items-center gap-1"><Users size={10} /> {b.attendees}</div>}
                            </div>
                        </div>
                    )) : <div className="h-full flex flex-col items-center justify-center text-slate-600 opacity-50"><DoorOpen size={32} strokeWidth={1} /><p className="mt-2 text-xs">{emptyText}</p></div>}
                </div>
            );

            return (
                <div ref={ref} className="h-full p-4 md:p-6 flex flex-col">
                    <div className="flex items-center justify-between mb-4"><h2 className={`${DASHBOARD_CONFIG.design.headersMobile} md:${DASHBOARD_CONFIG.design.headersDesktop} font-bold text-white tracking-tight`}>Händer & Bokningar</h2>{loading && <Loader2 className="animate-spin text-slate-600" size={20}/>}</div>
                    
                    {width > 900 ? (
                         <div className="flex flex-row gap-6 h-full min-h-0">
                             <div className="flex-[1.4] flex flex-col min-h-0">
                                <h3 className="text-xs font-bold uppercase tracking-widest text-slate-500 mb-2">Händer Framöver</h3>
                                <div className="flex-grow space-y-1.5 overflow-y-auto no-scrollbar pr-2">
                                    {loading && items.length === 0 ? <div className="space-y-2">{[1,2,3].map(i => <div key={i} className="h-12 bg-white/5 rounded-xl animate-pulse"></div>)}</div>
                                    : items.length > 0 ? items.map((item, idx) => {
                                         const isRec = item.type === 'recording';
                                         return (
                                            <div key={idx} className="flex items-center gap-3 md:gap-4 p-2 md:p-2 bg-white/5 rounded-xl border border-white/5 transition-all hover:bg-white/10">
                                                <div className={`flex flex-col items-center justify-center w-10 h-10 md:w-12 md:h-12 rounded-lg shrink-0 ${isRec ? 'bg-red-500/20 text-red-400' : 'bg-indigo-500/20 text-indigo-400'}`}>
                                                    <span className="font-bold text-sm md:text-base leading-none">{item.dateMain}</span>
                                                    <span className="text-[7px] md:text-[8px] font-bold uppercase mt-0.5">{item.dateSub}</span>
                                                </div>
                                                <div className="flex-grow min-w-0">
                                                    <h3 className="text-sm md:text-base font-semibold text-white truncate leading-tight">{item.title}</h3>
                                                    <div className="flex items-center gap-3 mt-0.5">
                                                        {isRec ? <Video size={12} className="text-red-400"/> : <Star size={12} className="text-indigo-400"/>}
                                                        <span className="text-xs font-bold uppercase tracking-wider text-slate-400">{item.subtitle}</span>
                                                        {item.timeStr && <span className="text-[10px] font-bold uppercase tracking-wider text-white bg-indigo-500/20 px-1.5 py-0.5 rounded-full ml-2">{item.timeStr}</span>}
                                                    </div>
                                                </div>
                                            </div>
                                         );
                                    }) : <div className="h-full flex flex-col items-center justify-center text-slate-600 opacity-50"><Calendar size={48} strokeWidth={1} /><p className="mt-2 text-sm">Inget inbokat</p></div>}
                                </div>
                             </div>
                             <div className="flex-1 flex flex-col min-h-0 border-l border-white/10 pl-4">
                                <h3 className="text-xs font-bold uppercase tracking-widest text-slate-500 mb-2">Konferensrum</h3>
                                {renderList(konfBookings, "Ledigt")}
                             </div>
                             <div className="flex-1 flex flex-col min-h-0 border-l border-white/10 pl-4">
                                <h3 className="text-xs font-bold uppercase tracking-widest text-slate-500 mb-2">Onlinerum</h3>
                                {renderList(onlineBookings, "Ledigt")}
                             </div>
                         </div>
                    ) : width > 550 ? (
                        <div className="flex flex-row gap-6 h-full min-h-0">
                             <div className="flex-1 flex flex-col min-h-0">
                                <h3 className="text-xs font-bold uppercase tracking-widest text-slate-500 mb-2">Händer Framöver</h3>
                                <div className="flex-grow space-y-1.5 overflow-y-auto no-scrollbar pr-2">
                                     {items.length > 0 ? items.map((item, idx) => (
                                         <div key={idx} className="flex items-center gap-2 p-2 bg-white/5 rounded-xl border border-white/5 hover:bg-white/10">
                                            <div className={`w-10 h-10 rounded-lg shrink-0 flex flex-col items-center justify-center ${item.type === 'recording' ? 'bg-red-500/20 text-red-400' : 'bg-indigo-500/20 text-indigo-400'}`}>
                                                <span className="font-bold text-sm leading-none">{item.dateMain}</span>
                                                <span className="text-[7px] font-bold uppercase">{item.dateSub}</span>
                                            </div>
                                            <div className="min-w-0">
                                                <h3 className="text-sm font-semibold text-white truncate">{item.title}</h3>
                                                <span className="text-[10px] text-slate-400">{item.timeStr || item.subtitle}</span>
                                            </div>
                                         </div>
                                     )) : <div className="text-slate-500 text-sm p-4">Inget inbokat</div>}
                                </div>
                             </div>
                             <div className="flex-1 flex flex-col min-h-0 border-l border-white/10 pl-4">
                                <div className="flex-1 flex flex-col min-h-0 mb-4">
                                    <h3 className="text-xs font-bold uppercase tracking-widest text-slate-500 mb-2">Konferensrum</h3>
                                    {renderList(konfBookings, "Ledigt")}
                                </div>
                                <div className="flex-1 flex flex-col min-h-0 border-t border-white/10 pt-2">
                                    <h3 className="text-xs font-bold uppercase tracking-widest text-slate-500 mb-2">Onlinerum</h3>
                                    {renderList(onlineBookings, "Ledigt")}
                                </div>
                             </div>
                        </div>
                    ) : (
                        <div className="flex flex-col h-full gap-4 overflow-y-auto no-scrollbar">
                             <div className="flex-shrink-0">
                                <h3 className="text-xs font-bold uppercase tracking-widest text-slate-500 mb-2">Händer Framöver</h3>
                                <div className="space-y-1.5">
                                     {items.slice(0, 4).map((item, idx) => (
                                         <div key={idx} className="flex items-center gap-2 p-2 bg-white/5 rounded-xl border border-white/5">
                                            <div className={`w-8 h-8 rounded shrink-0 flex flex-col items-center justify-center ${item.type === 'recording' ? 'bg-red-500/20 text-red-400' : 'bg-indigo-500/20 text-indigo-400'}`}>
                                                <span className="font-bold text-xs leading-none">{item.dateMain}</span>
                                            </div>
                                            <div className="min-w-0">
                                                <h3 className="text-sm font-semibold text-white truncate">{item.title}</h3>
                                            </div>
                                         </div>
                                     ))}
                                     {items.length === 0 && <div className="text-slate-500 text-sm">Inget inbokat</div>}
                                </div>
                             </div>
                             <div className="flex-shrink-0 border-t border-white/10 pt-4">
                                <h3 className="text-xs font-bold uppercase tracking-widest text-slate-500 mb-2">Konferensrum</h3>
                                <div className="space-y-1.5">
                                    {konfBookings.length > 0 ? konfBookings.map((b,i) => (
                                        <div key={i} className="flex justify-between p-2 bg-white/5 rounded-lg text-xs"><span className="text-white truncate mr-2">{b.title}</span><span className="text-slate-400 font-mono">{b.time}</span></div>
                                    )) : <div className="text-slate-500 text-xs">Ledigt</div>}
                                </div>
                             </div>
                             <div className="flex-shrink-0 border-t border-white/10 pt-4">
                                <h3 className="text-xs font-bold uppercase tracking-widest text-slate-500 mb-2">Onlinerum</h3>
                                <div className="space-y-1.5">
                                    {onlineBookings.length > 0 ? onlineBookings.map((b,i) => (
                                        <div key={i} className="flex justify-between p-2 bg-white/5 rounded-lg text-xs"><span className="text-white truncate mr-2">{b.title}</span><span className="text-slate-400 font-mono">{b.time}</span></div>
                                    )) : <div className="text-slate-500 text-xs">Ledigt</div>}
                                </div>
                             </div>
                        </div>
                    )}
                </div>
            );
        };

        const HelpModal = ({ onClose }) => (
            <div className={`modal-overlay open`} onClick={onClose}>
                <div className="glass-card p-6 max-w-md w-full m-4" onClick={e => e.stopPropagation()}>
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-bold text-white">Hjälp & Info</h2>
                        <button onClick={onClose}><X className="text-slate-400 hover:text-white" /></button>
                    </div>
                    <div className="text-slate-300 text-sm space-y-2">
                        <p>Dra och släpp korten för att flytta dem (på desktop).</p>
                        <p>Använd handtaget i nedre högra hörnet för att ändra storlek.</p>
                        <p>Klicka på produktionssiffror för att se detaljer.</p>
                        <p>Data hämtas från ClickUp, Google Calendar och Google Sheets.</p>
                    </div>
                </div>
            </div>
        );

        // --- NEW SETTINGS MODAL ---
        const SettingsModal = ({ showRevenue, toggleRevenue, currentYear, setYear, onClose }) => {
            const [localYear, setLocalYear] = useState(currentYear);

            const handleYearChange = (e) => {
                setLocalYear(e.target.value);
                setYear(e.target.value);
            };

            return (
                <div className={`modal-overlay open`} onClick={onClose}>
                    <div className="glass-card p-6 max-w-sm w-full m-4" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl font-bold text-white flex items-center gap-2"><Settings size={20}/> Inställningar</h2>
                            <button onClick={onClose}><X className="text-slate-400 hover:text-white" /></button>
                        </div>
                        <div className="space-y-6">
                             <div className="flex items-center justify-between">
                                <span className="text-slate-300 font-medium">Visa intäkter (SEK)</span>
                                <div className="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" name="toggle" id="revenue-toggle" className="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all duration-300" checked={showRevenue} onChange={toggleRevenue}/>
                                    <label htmlFor="revenue-toggle" className={`toggle-label block overflow-hidden h-6 rounded-full cursor-pointer transition-colors duration-300 ${showRevenue ? 'bg-green-400' : 'bg-slate-600'}`}></label>
                                </div>
                            </div>
                            
                            <div className="space-y-2">
                                <label className="text-slate-300 font-medium block">Årtal</label>
                                <input 
                                    type="number" 
                                    value={localYear} 
                                    onChange={handleYearChange}
                                    className="w-full bg-white/10 border border-white/20 rounded px-3 py-2 text-white font-bold tracking-widest focus:outline-none focus:border-white/40 text-center"
                                />
                                <p className="text-xs text-slate-500 mt-1">Ändrar vilket år data visas för (t.ex. 2025).</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const DetailsModal = ({ title, items, onClose }) => (
            <div className={`modal-overlay open`} onClick={onClose}>
                <div className="glass-card p-6 max-w-2xl w-full m-4 max-h-[80vh] flex flex-col" onClick={e => e.stopPropagation()}>
                    <div className="flex justify-between items-center mb-4 shrink-0">
                        <h2 className="text-xl font-bold text-white">{title}</h2>
                        <button onClick={onClose}><X className="text-slate-400 hover:text-white" /></button>
                    </div>
                    <div className="overflow-y-auto min-h-0 space-y-2 pr-2">
                        {items && items.length > 0 ? items.map((item, i) => (
                             <div key={i} className="flex justify-between items-center p-3 bg-white/5 rounded-lg border border-white/5 hover:bg-white/10">
                                 <span className="text-white font-medium truncate mr-4">{item.name || item.project}</span>
                                 <div className="text-right shrink-0">
                                     <div className="text-xs text-slate-400 uppercase font-bold">{item.status || item.date}</div>
                                     {item.budget > 0 && <div className="text-[10px] text-emerald-400 font-mono">{item.budget.toLocaleString()} kr</div>}
                                 </div>
                             </div>
                        )) : <p className="text-slate-500 italic">Ingen data att visa.</p>}
                    </div>
                </div>
            </div>
        );

        // --- DEFAULTS ---
        const DEFAULT_MODULES = [ 
            { id: 'production', colSpan: 12, rowSpan: 3, component: 'ProductionModule' }, 
            { id: 'timeline', colSpan: 12, rowSpan: 3, component: 'TimelineModule' }, 
            { id: 'slideshow', colSpan: 12, rowSpan: 2, component: 'SlideshowModule' }, 
        ];

        const App = () => {
            const [time, setTime] = useState(new Date());
            const [weather, setWeather] = useState(null); const [loadingWeather, setLoadingWeather] = useState(true);
            const [birthdays, setBirthdays] = useState([]); const [loadingBirthdays, setLoadingBirthdays] = useState(true);
            const [events, setEvents] = useState([]); 
            const [prodStats, setProdStats] = useState(null); const [loadingProd, setLoadingProd] = useState(true);
            const [nameDays, setNameDays] = useState("Laddar..."); const [loadingNameDays, setLoadingNameDays] = useState(true); 
            const [bookings, setBookings] = useState([]);
            const [customText, setCustomText] = useState({ title: "Every frame counts", subtitle: "Life at Crisp" });
            
            const [showHelp, setShowHelp] = useState(false); 
            const [showSettings, setShowSettings] = useState(false);
            
            // --- PERSISTENT STATE LOGIC ---
            
            // Settings persistence (Revenue)
            const [showRevenue, setShowRevenue] = useState(() => {
                try {
                    return localStorage.getItem('dashboard_show_revenue') === 'true';
                } catch(e) { return false; }
            });

            // Settings persistence (Year)
            const [year, setYear] = useState(() => {
                try {
                    return localStorage.getItem('dashboard_year') || new Date().getFullYear().toString();
                } catch(e) { return new Date().getFullYear().toString(); }
            });

            const toggleRevenueHandler = () => {
                setShowRevenue(prev => {
                    const newVal = !prev;
                    localStorage.setItem('dashboard_show_revenue', String(newVal));
                    return newVal;
                });
            };

            const setYearHandler = (newYear) => {
                setYear(newYear);
                localStorage.setItem('dashboard_year', newYear);
            };

            const [detailModal, setDetailModal] = useState(null); 
            const lastForcedReloadTime = useRef(0);
            const RELOAD_COOLDOWN_MS = 10 * 60 * 1000; 

            // Modules persistence
            const [modules, setModules] = useState(() => {
                try {
                    const saved = localStorage.getItem('dashboard_layout_v1');
                    if (saved) {
                        return JSON.parse(saved);
                    }
                } catch(e) { console.error("Layout load failed", e); }
                return DEFAULT_MODULES;
            });

            useEffect(() => {
                try {
                    localStorage.setItem('dashboard_layout_v1', JSON.stringify(modules));
                } catch(e) {}
            }, [modules]);

            const [draggedId, setDraggedId] = useState(null); const [resizingId, setResizingId] = useState(null);

            const onDragStart = (e, id) => { if (window.innerWidth >= 768 && !resizingId) { setDraggedId(id); e.currentTarget.classList.add('dragging'); } };
            const onDragEnd = (e) => { setDraggedId(null); e.currentTarget.classList.remove('dragging'); };
            const onDrop = (targetId) => { if (window.innerWidth < 768 || !draggedId || draggedId === targetId) return; const n = [...modules]; const d = n.findIndex(m => m.id === draggedId); const t = n.findIndex(m => m.id === targetId); const tmp = n[d]; n.splice(d, 1); n.splice(t, 0, tmp); setModules(n); };
            const handleResizeStart = (e, id) => { if (window.innerWidth < 768) return; e.preventDefault(); e.stopPropagation(); setResizingId(id); const sx = e.clientX; const sy = e.clientY; const idx = modules.findIndex(m => m.id === id); const sc = modules[idx].colSpan; const sr = modules[idx].rowSpan; const cw = (window.innerWidth - 64) / 12; const ch = 184; const onMM = (me) => { const c = Math.max(3, Math.min(12, sc + Math.round((me.clientX-sx)/cw))); const r = Math.max(1, Math.min(6, sr + Math.round((me.clientY-sy)/ch))); setModules(p => { const nx = [...p]; if(nx[idx].colSpan !== c || nx[idx].rowSpan !== r) nx[idx]={...nx[idx], colSpan:c, rowSpan:r}; return nx; }); }; const onMU = () => { setResizingId(null); document.removeEventListener('mousemove', onMM); document.removeEventListener('mouseup', onMU); }; document.addEventListener('mousemove', onMM); document.addEventListener('mouseup', onMU); };

            const openDetails = (title, items) => {
                setDetailModal({ title, items });
            };

            const renderModuleContent = (mod) => {
                 const allUpcoming = [
                    ...(events || []).map(e => ({ ...e, type: 'event', title: e.name, subtitle: 'Event' })),
                    ...(prodStats?.recordings || []).map(r => ({ ...r, type: 'recording', title: r.project, subtitle: r.isStream ? 'Stream' : (r.isVO ? 'Voiceover' : 'Inspelning') }))
                ].sort((a, b) => a.sortDate - b.sortDate).slice(0, 8); 
                switch(mod.component) { 
                    case 'WeatherModule': return <WeatherModule data={weather} loading={loadingWeather} />; 
                    case 'ProductionModule': return <ProductionModule stats={prodStats?.stats} recent={prodStats?.recentDeliveries} loading={loadingProd} showRevenue={showRevenue} year={year} onOpenDetails={openDetails} />; 
                    case 'SlideshowModule': return <SlideshowModule customText={customText} />; 
                    case 'TimelineModule': return <TimelineModule items={allUpcoming} bookings={bookings} loading={loadingProd} />; 
                    default: return null; 
                }
            };

            // Main Data Loader
            const loadMainData = async () => {
                setLoadingWeather(true);
                setLoadingBirthdays(true);
                setLoadingNameDays(true);
                setLoadingProd(true); 

                try { setWeather(await getRealWeather()); } catch(e){}
                try { setEvents(await getGoogleSheetEvents()); } catch(e){}
                try { setBirthdays(await getClickUpBirthdays()); } catch(e){}
                try { setBookings(await getRoomBookings()); } catch(e){}
                try { setNameDays(await getNamnsdagar()); } catch(e) { setNameDays("Kunde inte hämta"); }
                try { setProdStats(await getClickUpProductionData(year)); } catch(e) { console.error(e); }

                setLoadingWeather(false);
                setLoadingBirthdays(false);
                setLoadingNameDays(false);
                setLoadingProd(false);
            };

            // Reload data when year changes
            useEffect(() => {
                loadMainData();
            }, [year]);

            useEffect(() => {
                const t = setInterval(() => setTime(new Date()), 1000);

                const loadTextOnly = async () => {
                    try {
                        const data = await getGoogleSheetMotto();
                        if(data) {
                            setCustomText(prev => (prev.title === data.title && prev.subtitle === data.subtitle) ? prev : { title: data.title, subtitle: data.subtitle });
                            if (data.shouldReload === 'RELOAD') {
                                const now = Date.now();
                                const lastReload = parseInt(localStorage.getItem('last_reload_timestamp') || '0');
                                if (now - lastReload > RELOAD_COOLDOWN_MS) {
                                    localStorage.setItem('last_reload_timestamp', now.toString());
                                    window.location.reload();
                                }
                            } 
                        }
                    } catch(e){}
                };

                loadTextOnly();

                const textInterval = setInterval(loadTextOnly, 10000);
                const mainInterval = setInterval(() => {
                    if (new Date().getMinutes() === 0) {
                        loadMainData();
                    }
                }, 60000); 

                return () => { clearInterval(t); clearInterval(textInterval); clearInterval(mainInterval); };
            }, []);

            const timeStr = time.toLocaleTimeString('sv-SE', { hour: '2-digit', minute: '2-digit' }); const dateStr = time.toLocaleDateString('sv-SE', { weekday: 'long', day: 'numeric', month: 'long' });

            return (
                <div className="min-h-screen p-4 md:p-8 flex flex-col md:h-screen bg-[#050505] overflow-y-auto md:overflow-hidden relative">
                    {/* HEADER */}
                    <header className="grid grid-cols-1 md:grid-cols-3 gap-4 items-center mb-6 px-2 md:px-4 pt-2 animate-in shrink-0 z-50 pointer-events-none h-auto md:h-[140px] text-center md:text-left relative">
                         <div className="flex flex-col items-center md:items-start order-1">
                             <div className="flex items-center gap-3">
                                <img src={LOGO_SYMBOL} alt="Crisp" className={`${DASHBOARD_CONFIG.design.logoSymbolHeightMobile} md:${DASHBOARD_CONFIG.design.logoSymbolHeightDesktop} w-auto object-contain`} onError={(e) => e.target.style.display = 'none'} />
                                <img src={LOGO_TEXT} alt="Crisp Film" className={`${DASHBOARD_CONFIG.design.logoTextHeightMobile} md:${DASHBOARD_CONFIG.design.logoTextHeightDesktop} w-auto object-contain mt-1`} onError={(e) => e.target.style.display = 'none'} />
                             </div>
                        </div>
                        <div className="flex flex-col items-center justify-center order-2 md:order-2">
                            <div className={`${DASHBOARD_CONFIG.design.clockSizeMobile} md:${DASHBOARD_CONFIG.design.clockSizeDesktop} font-semibold text-white tracking-tighter leading-none`}>{timeStr}</div>
                            <div className={`text-slate-400 ${DASHBOARD_CONFIG.design.dateSizeMobile} md:${DASHBOARD_CONFIG.design.dateSizeDesktop} capitalize font-medium mt-1 mb-2`}>{dateStr}</div>
                            <p className="text-slate-400 text-sm md:text-base font-medium tracking-wide uppercase opacity-80 whitespace-nowrap">We make brands stronger through film</p>
                        </div>
                        <div className="flex flex-col items-center md:items-end justify-center gap-4 order-3 md:order-3">
                             <HeaderWeather weather={weather} loading={loadingWeather} />
                             <HeaderInfoModule nameDays={loadingNameDays ? "Laddar..." : nameDays} birthdays={loadingBirthdays ? [] : birthdays} />
                        </div>
                    </header>
                    
                    <button onClick={() => setShowSettings(true)} className="fixed bottom-4 left-4 text-slate-600 hover:text-white transition-colors pointer-events-auto z-50"><Settings size={24} /></button>
                    <button onClick={() => setShowHelp(true)} className="fixed bottom-4 left-14 text-slate-600 hover:text-white transition-colors pointer-events-auto z-50"><HelpCircle size={24} /></button>

                    {showHelp && <HelpModal onClose={() => setShowHelp(false)} />}
                    {showSettings && <SettingsModal showRevenue={showRevenue} toggleRevenue={toggleRevenueHandler} currentYear={year} setYear={setYearHandler} onClose={() => setShowSettings(false)} />}
                    {detailModal && <DetailsModal title={detailModal.title} items={detailModal.items} onClose={() => setDetailModal(null)} />}
                    <div className="grid grid-cols-1 md:grid-cols-12 auto-rows-auto md:auto-rows-[140px] gap-4 md:gap-5 flex-grow pb-4 grid-flow-dense relative z-10">
                        {modules.map((mod) => ( 
                            <div 
                                key={mod.id} 
                                draggable={!resizingId} 
                                onDragStart={(e) => onDragStart(e, mod.id)} 
                                onDragEnd={onDragEnd} 
                                onDragOver={(e) => e.preventDefault()} 
                                onDrop={() => onDrop(mod.id)} 
                                className={`${mod.noGlass ? 'transparent-container' : 'glass-card'} animate-in col-span-1 md:col-span-${mod.colSpan} md:row-span-${mod.rowSpan} min-h-[300px] md:min-h-0 ${draggedId === mod.id ? 'dragging' : ''} ${resizingId === mod.id ? 'resizing' : ''}`}
                            > 
                                {renderModuleContent(mod)} 
                                <div className="resize-handle" onMouseDown={(e) => handleResizeStart(e, mod.id)}></div> 
                            </div> 
                        ))}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>