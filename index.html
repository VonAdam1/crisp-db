<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crisp Production Dashboard</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@0.292.0"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { 
            font-family: 'Outfit', sans-serif; 
            background-color: #050505; 
            color: #f5f5f7; 
            overflow: hidden; 
            background: radial-gradient(circle at 50% -20%, #1a1a1a 0%, #000000 60%);
            user-select: none;
        }
        
        /* Premium Glass */
        .glass-card { 
            background: rgba(20, 20, 20, 0.75); 
            backdrop-filter: blur(60px); 
            -webkit-backdrop-filter: blur(60px);
            border: 1px solid rgba(255, 255, 255, 0.08); 
            box-shadow: 0 30px 80px -20px rgba(0, 0, 0, 0.8);
            position: absolute;
            display: flex;
            flex-direction: column;
            border-radius: 2rem;
            overflow: hidden;
            transition: box-shadow 0.2s ease, border-color 0.2s ease;
        }

        .glass-card:hover {
            border-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 40px 100px -20px rgba(0, 0, 0, 0.9);
            z-index: 50; 
        }
        
        /* NÃ¤r kortet dras */
        .glass-card.dragging {
            cursor: grabbing;
            z-index: 9999 !important;
            border-color: rgba(255, 255, 255, 0.5);
            box-shadow: 0 50px 120px -30px black;
            transition: none; 
        }

        /* Resize Handle */
        .resize-handle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 40px;
            height: 40px;
            cursor: nwse-resize;
            z-index: 60;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .resize-handle::after {
            content: '';
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 12px;
            height: 12px;
            border-bottom: 3px solid rgba(255,255,255,0.6);
            border-right: 3px solid rgba(255,255,255,0.6);
            border-radius: 2px;
        }

        .glass-card:hover .resize-handle { opacity: 1; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .animate-fade { animation: fadeIn 1s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- IKONER ---
        const createLucideIcon = (name) => {
            if (!window.lucide || !window.lucide.icons) return () => null;
            const iconData = window.lucide.icons[name];
            if (!iconData) return () => null;
            return ({ size = 24, className = "", color = "currentColor", ...props }) => {
                if (!Array.isArray(iconData)) return null;
                const [tag, defaultAttrs, children = []] = iconData;
                const toCamel = (s) => s.replace(/-([a-z])/g, (g) => g[1].toUpperCase());
                const processAttrs = (attrs) => {
                    const newAttrs = {};
                    for (const [k, v] of Object.entries(attrs || {})) {
                        const key = k === 'class' ? 'className' : toCamel(k);
                        newAttrs[key] = v;
                    }
                    return newAttrs;
                };
                const combinedAttrs = { ...processAttrs(defaultAttrs), width: size, height: size, stroke: color, className: `lucide lucide-${name.toLowerCase()} ${className}`, ...props };
                const childElements = Array.isArray(children) ? children.map(([childTag, childAttrs], idx) => React.createElement(childTag, { ...processAttrs(childAttrs), key: idx })) : [];
                return React.createElement(tag, combinedAttrs, ...childElements);
            };
        };

        const CloudRain = createLucideIcon('CloudRain');
        const Sun = createLucideIcon('Sun');
        const CloudSun = createLucideIcon('CloudSun');
        const Cloud = createLucideIcon('Cloud');
        const Snowflake = createLucideIcon('Snowflake');
        const CloudLightning = createLucideIcon('CloudLightning');
        const CheckSquare = createLucideIcon('CheckSquare');
        const Cake = createLucideIcon('Cake');
        const Wind = createLucideIcon('Wind');
        const Droplets = createLucideIcon('Droplets');
        const Video = createLucideIcon('Video');
        const Trophy = createLucideIcon('Trophy');
        const Calendar = createLucideIcon('Calendar');
        const MapPin = createLucideIcon('MapPin');
        const ArrowRight = createLucideIcon('ArrowRight');
        const PackageCheck = createLucideIcon('PackageCheck');
        const Star = createLucideIcon('Star');
        const Image = createLucideIcon('Image');
        const RefreshCw = createLucideIcon('RefreshCw');
        const PartyPopper = createLucideIcon('PartyPopper');
        const Thermometer = createLucideIcon('Thermometer');
        const Eye = createLucideIcon('Eye');
        const Move = createLucideIcon('Move');

        // --- KONFIGURATION ---
        const CLICKUP_API_TOKEN = "pk_206499020_MHKUBIAUIQI6N64DO4IMSVAYIEW3HKM9";
        const CLICKUP_SPACE_ID = "90155050040"; 
        const CLICKUP_BIRTHDAY_LIST_ID = "901517968972";
        const CLICKUP_PROJECTS_LIST_ID = "901515357300"; 
        const GOOGLE_SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTg2K8CukJPbpDaXCSFymNJK67nEIDcciuJSiy8xvibV1cziFBovc9mDPf9vmqyQceIEck6wfy0ly36/pub?gid=0&single=true&output=csv"; 
        const START_DATE_TIMESTAMP = new Date('2025-01-01').getTime();
        const UPDATE_SCHEDULE = ['07:00', '12:30', '16:00'];

        const LOGO_SYMBOL = "./Crisp-Symbol-White.png";
        const LOGO_TEXT = "./Crisp_text-logo_white.png";
        
        // Inga standardbilder - Vi letar lokalt
        const SLIDESHOW_IMAGES = [];

        // GRÃ„NSER
        const SCREEN_PADDING = 20;
        const HEADER_HEIGHT = 180;

        // --- MODULER ---

        const WeatherModule = ({ data, w, h }) => {
            const isCompact = h < 2;

            const getWeatherIcon = (code, size, className) => {
                if (code === 0) return <Sun size={size} className={`text-yellow-400 ${className}`} />;
                if (code >= 1 && code <= 3) return <CloudSun size={size} className={`text-white ${className}`} />;
                if (code >= 45 && code <= 48) return <Cloud size={size} className={`text-slate-400 ${className}`} />;
                if (code >= 51 && code <= 67) return <CloudRain size={size} className={`text-blue-400 ${className}`} />;
                if (code >= 71 && code <= 77) return <Snowflake size={size} className={`text-cyan-200 ${className}`} />;
                if (code >= 95) return <CloudLightning size={size} className={`text-purple-400 ${className}`} />;
                return <CloudSun size={size} className={`text-white ${className}`} />;
            };

            return (
                <div className="h-full flex flex-col justify-between relative overflow-hidden p-6 md:p-8">
                    <div className="absolute inset-0 bg-gradient-to-br from-blue-500/10 to-transparent pointer-events-none"></div>
                    <div className="relative z-10 flex justify-between items-start">
                        <div>
                            <div className="flex items-center gap-2 text-blue-300 text-xs font-bold uppercase tracking-widest mb-2">
                                <MapPin size={14} /> Stockholm
                            </div>
                            <div className={`font-bold tracking-tighter text-white leading-none ${isCompact ? 'text-6xl' : 'text-8xl'}`}>
                                {data?.temp !== undefined ? Math.round(data.temp) : "--"}Â°
                            </div>
                            {!isCompact && (
                                <div className="mt-3">
                                    <div className="text-xl text-slate-300 font-medium mt-2">{data?.condition}</div>
                                    <div className="flex items-center gap-3 mt-1 text-sm text-slate-400 font-medium">
                                        <span className="flex items-center gap-1"><Thermometer size={14}/> KÃ¤nns som {data?.feelsLike !== undefined ? Math.round(data.feelsLike) : "-"}Â°</span>
                                    </div>
                                </div>
                            )}
                        </div>
                        <div className={`bg-white/5 rounded-full border border-white/10 shadow-2xl flex items-center justify-center ${isCompact ? 'p-3' : 'p-5'}`}>
                            {getWeatherIcon(data?.code, isCompact?40:64, "")}
                        </div>
                    </div>

                    {!isCompact && (
                        <div className="animate-in flex flex-col gap-4">
                             {data?.hourly && data.hourly.length > 0 && (
                                 <div className="flex justify-between items-center pt-4 border-t border-white/10">
                                     {data.hourly.slice(0, 4).map((h, i) => (
                                         <div key={i} className="flex flex-col items-center text-center gap-1">
                                             <span className="text-slate-500 text-[10px] font-bold">{h.time}</span>
                                             {getWeatherIcon(h.code, 18, "")}
                                             <span className="text-white text-xs font-bold">{Math.round(h.temp)}Â°</span>
                                         </div>
                                     ))}
                                 </div>
                             )}
                             {data?.forecast && data.forecast.length > 0 && (
                                <div className="grid grid-cols-3 gap-2 pt-2 relative z-10">
                                    {data.forecast.map((day, i) => (
                                        <div key={i} className="flex flex-col items-center text-center p-2 rounded-xl bg-white/5">
                                            <span className="text-slate-400 text-[10px] font-bold uppercase mb-1">{day.day}</span>
                                            {getWeatherIcon(day.code, 20, "mb-1")}
                                            <span className="text-white font-bold text-sm">{Math.round(day.temp)}Â°</span>
                                        </div>
                                    ))}
                                </div>
                             )}
                        </div>
                    )}
                </div>
            );
        };

        const ProductionModule = ({ stats, recent, loading, h }) => {
            return (
                <div className="h-full p-6 md:p-8 flex flex-col gap-6 relative overflow-hidden">
                    <div className="flex items-center gap-3 mb-2">
                        <Trophy className="text-orange-400" size={32} />
                        <h2 className="text-xl md:text-2xl font-bold uppercase tracking-wide text-white">Produktion 2025</h2>
                    </div>

                    <div className="grid grid-cols-2 gap-6 shrink-0">
                        <div className="bg-slate-800/50 rounded-2xl p-4 border border-blue-500/20 flex flex-col items-center justify-center text-center">
                             <span className="text-3xl md:text-4xl font-black text-blue-400 tracking-tighter">{loading ? "-" : stats?.activeProjects}</span>
                             <span className="text-[10px] font-bold text-slate-400 uppercase mt-1 tracking-widest">IgÃ¥ng Nu</span>
                        </div>
                        <div className="bg-slate-800/50 rounded-2xl p-4 border border-purple-500/20 flex flex-col items-center justify-center text-center">
                             <span className="text-3xl md:text-4xl font-black text-purple-400 tracking-tighter">{loading ? "-" : stats?.totalProjects2025}</span>
                             <span className="text-[10px] font-bold text-slate-400 uppercase mt-1 tracking-widest">Totalt 2025</span>
                        </div>
                        <div className="bg-slate-800/50 rounded-2xl p-4 border border-emerald-500/20 flex flex-col items-center justify-center text-center">
                             <span className="text-3xl md:text-4xl font-black text-emerald-400 tracking-tighter">{loading ? "-" : stats?.year}</span>
                             <span className="text-[10px] font-bold text-slate-400 uppercase mt-1 tracking-widest">Lev. Tasks</span>
                        </div>
                        <div className="bg-slate-800/50 rounded-2xl p-4 border border-orange-500/20 flex flex-col items-center justify-center text-center">
                             <span className="text-3xl md:text-4xl font-black text-orange-400 tracking-tighter">{loading ? "-" : stats?.occasions}</span>
                             <span className="text-[10px] font-bold text-slate-400 uppercase mt-1 tracking-widest">Insp. Dagar</span>
                        </div>
                    </div>

                    {h >= 3 && (
                        <div className="flex-grow flex flex-col min-h-0 animate-fade pt-4 border-t border-white/5">
                            <div className="flex items-center gap-3 mb-4 text-emerald-400 mt-2">
                                <PackageCheck size={18} />
                                <h3 className="text-xs font-bold uppercase tracking-widest">Nyligen Levererat</h3>
                            </div>
                            <div className="space-y-2 overflow-y-auto no-scrollbar flex-grow">
                                {recent?.length > 0 ? recent.map((del, i) => (
                                    <div key={i} className="flex justify-between items-center p-3 rounded-xl bg-white/5 border border-white/5">
                                        <span className="text-white font-medium text-sm truncate mr-2">{del.name}</span>
                                        <span className="text-[10px] font-bold text-emerald-400 uppercase tracking-wider bg-emerald-500/10 px-2 py-1 rounded">{del.date}</span>
                                    </div>
                                )) : <p className="text-sm text-slate-500 italic">Inget nyligen.</p>}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const BirthdaysModule = ({ birthdays }) => (
             <div className="h-full p-6 md:p-8 flex flex-col">
                <div className="flex items-center gap-3 mb-6 text-pink-400">
                    <PartyPopper size={28} />
                    <h3 className="text-lg md:text-xl font-bold uppercase tracking-widest text-white">Fyller Ã¥r (30 dagar)</h3>
                </div>
                <div className="space-y-4 overflow-y-auto no-scrollbar flex-grow">
                    {birthdays?.length > 0 ? birthdays.map((b, i) => (
                        <div key={i} className="flex items-center gap-5 p-4 rounded-2xl bg-white/5 hover:bg-white/10 transition-colors border border-white/5">
                            <div className="w-12 h-12 md:w-14 md:h-14 rounded-full bg-gradient-to-br from-pink-500 to-purple-600 flex items-center justify-center text-white text-lg md:text-xl font-bold shadow-lg shrink-0">
                                {b.name.charAt(0)}
                            </div>
                            <div>
                                <div className="text-white text-xl md:text-2xl font-bold">{b.name}</div>
                                <div className="text-pink-300 text-sm md:text-base font-bold uppercase tracking-wide mt-0.5">{b.dateStr} {b.isSoon && "ðŸŽ‚"}</div>
                            </div>
                        </div>
                    )) : <div className="h-full flex items-center justify-center text-slate-500 text-sm italic">Inga fÃ¶delsedagar nÃ¤ra.</div>}
                </div>
             </div>
        );

        const SlideshowModule = ({ customImages }) => {
            // PRIORITERING: 1. Lokala bilder. 2. Inga bilder (visa placeholder)
            const images = customImages && customImages.length > 0 ? customImages : [];
            
            const [index, setIndex] = useState(0);
            useEffect(() => {
                if (images.length <= 1) return;
                const timer = setInterval(() => setIndex((prev) => (prev + 1) % images.length), 8000);
                return () => clearInterval(timer);
            }, [images]);

            if (images.length === 0) {
                return (
                     <div className="h-full w-full relative group overflow-hidden bg-slate-900 flex flex-col items-center justify-center text-center p-8 rounded-[2rem]">
                        <Image size={48} className="text-slate-700 mb-4" />
                        <h2 className="text-2xl font-bold text-white">Life at Crisp</h2>
                        <p className="text-slate-500 text-sm mt-2 max-w-xs">LÃ¤gg bilder i mappen "bilder" (1.jpg, 2.png...) fÃ¶r att starta bildspelet.</p>
                    </div>
                );
            }

            return (
                <div className="h-full w-full relative group overflow-hidden rounded-[2rem] bg-black cursor-grab active:cursor-grabbing">
                    {images.map((img, i) => (
                        <div key={i} className="absolute inset-0 bg-cover transition-all duration-[2000ms] ease-in-out transform"
                            style={{ 
                                backgroundImage: `url('${img}')`, 
                                backgroundPosition: 'center center', 
                                opacity: index === i ? 1 : 0, 
                                transform: index === i ? 'scale(1)' : 'scale(1.05)' 
                            }} />
                    ))}
                    <div className="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent"></div>
                    <div className="absolute bottom-8 left-8 pointer-events-none">
                         <div className="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-white/10 backdrop-blur-md border border-white/10 text-xs font-bold uppercase tracking-widest text-white mb-2">
                            <Image size={14} /> Life at Crisp
                        </div>
                        <h2 className="text-3xl md:text-4xl font-bold text-white tracking-tight">Creating Magic</h2>
                    </div>
                </div>
            );
        };

        const TimelineModule = ({ items, loading }) => (
            <div className="h-full p-6 md:p-8 flex flex-col">
                <div className="flex items-center justify-between mb-8">
                    <h2 className="text-2xl md:text-3xl font-bold text-white tracking-tight">HÃ¤nder FramÃ¶ver</h2>
                    {loading && <RefreshCw className="animate-spin text-slate-600" size={24}/>}
                </div>
                <div className="flex-grow space-y-4 overflow-y-auto no-scrollbar pr-2">
                    {items.length > 0 ? items.map((item, idx) => {
                         const isRec = item.type === 'recording';
                         return (
                            <div key={idx} className="flex items-center gap-5 md:gap-6 p-4 md:p-5 bg-white/5 rounded-3xl border border-white/5 transition-all hover:bg-white/10">
                                <div className={`flex flex-col items-center justify-center w-16 h-16 md:w-20 md:h-20 rounded-2xl shrink-0 ${isRec ? 'bg-red-500/20 text-red-400' : 'bg-indigo-500/20 text-indigo-400'}`}>
                                    <span className="font-bold text-2xl md:text-3xl leading-none">{item.dateMain}</span>
                                    <span className="text-[10px] md:text-xs font-bold uppercase mt-0.5">{item.dateSub}</span>
                                </div>
                                <div className="flex-grow min-w-0">
                                    <h3 className="text-lg md:text-2xl font-semibold text-white truncate leading-tight">{item.title}</h3>
                                    <div className="flex items-center gap-3 mt-1.5">
                                         {isRec ? <Video size={16} className="text-red-400"/> : <Star size={16} className="text-indigo-400"/>}
                                         <span className="text-xs md:text-base font-bold uppercase tracking-wider text-slate-400">{item.subtitle}</span>
                                    </div>
                                </div>
                            </div>
                         );
                    }) : (
                        <div className="h-full flex flex-col items-center justify-center text-slate-600 opacity-50">
                            <Calendar size={64} strokeWidth={1} />
                            <p className="mt-4 text-xl font-medium">Kalendern Ã¤r tom</p>
                        </div>
                    )}
                </div>
            </div>
        );

        // --- SMART TILE (FRI FLYTT) ---
        const SmartTile = ({ id, x, y, w, h, zIndex, onMove, onResize, onSelect, children }) => {
            const [isDragging, setIsDragging] = useState(false);
            const [isResizing, setIsResizing] = useState(false);

            // SkÃ¤rmgrÃ¤nser
            const constrain = (val, min, max) => Math.min(Math.max(val, min), max);

            const handleMouseDown = (e) => {
                if (e.target.classList.contains('resize-handle')) return;
                e.stopPropagation(); e.preventDefault();
                onSelect(id);
                setIsDragging(true);
                
                const startMouseX = e.clientX; const startMouseY = e.clientY;
                const startX = x; const startY = y;

                const onMouseMove = (ev) => {
                    const dx = ev.clientX - startMouseX;
                    const dy = ev.clientY - startMouseY;
                    
                    let nextX = constrain(startX + dx, SCREEN_PADDING, window.innerWidth - w - SCREEN_PADDING);
                    let nextY = constrain(startY + dy, HEADER_HEIGHT, window.innerHeight - h - SCREEN_PADDING);

                    onMove(id, nextX, nextY);
                };

                const onMouseUp = () => {
                    setIsDragging(false);
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                };
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            };

            const handleResizeDown = (e) => {
                e.stopPropagation(); e.preventDefault();
                onSelect(id);
                setIsResizing(true);

                const startMouseX = e.clientX; const startMouseY = e.clientY;
                const startW = w; const startH = h;

                const onResizeMove = (ev) => {
                    const dw = ev.clientX - startMouseX;
                    const dh = ev.clientY - startMouseY;
                    
                    let nextW = Math.max(300, startW + dw);
                    let nextH = Math.max(200, startH + dh);

                    if (x + nextW > window.innerWidth - SCREEN_PADDING) nextW = window.innerWidth - SCREEN_PADDING - x;
                    if (y + nextH > window.innerHeight - SCREEN_PADDING) nextH = window.innerHeight - SCREEN_PADDING - y;

                    onResize(id, nextW, nextH);
                };

                const onResizeUp = () => {
                    setIsResizing(false);
                    document.removeEventListener('mousemove', onResizeMove);
                    document.removeEventListener('mouseup', onResizeUp);
                };
                document.addEventListener('mousemove', onResizeMove);
                document.addEventListener('mouseup', onResizeUp);
            };

            return (
                <div 
                    onMouseDown={handleMouseDown}
                    className={`glass-card animate-fade ${isDragging ? 'dragging' : ''} ${isResizing ? 'resizing' : ''}`}
                    style={{ left: x, top: y, width: w, height: h, zIndex: (isDragging || isResizing) ? 9999 : zIndex }}
                >
                    <div className={`h-full w-full ${isDragging || isResizing ? 'pointer-events-none' : ''}`}>{children}</div>
                    <div className="resize-handle" onMouseDown={handleResizeDown} title="Dra fÃ¶r att Ã¤ndra storlek"></div>
                </div>
            );
        };

        const App = () => {
            const [time, setTime] = useState(new Date());
            const [data, setData] = useState(null);
            const [weather, setWeather] = useState(null);
            const [loading, setLoading] = useState(true);
            const [images, setImages] = useState([]);

            // INITIAL LAYOUT (DESKTOP) - Ã…terstÃ¤llt till bilden du gillade
            const [modules, setModules] = useState([
                // VÃ„NSTER KOLUMN
                { id: 'weather',    x: 40,  y: 200, w: 480, h: 400, z: 1, component: 'WeatherModule' },
                { id: 'production', x: 40,  y: 620, w: 480, h: 420, z: 2, component: 'ProductionModule' },
                { id: 'slideshow',  x: 40,  y: 1060, w: 1000, h: 800, z: 3, component: 'SlideshowModule' },
                // HÃ–GER KOLUMN
                { id: 'birthdays',  x: 540, y: 200, w: 500, h: 350, z: 4, component: 'BirthdaysModule' },
                { id: 'timeline',   x: 540, y: 570, w: 500, h: 470, z: 5, component: 'TimelineModule' },
            ]);

            const updateModulePos = (id, x, y) => {
                setModules(prev => prev.map(m => m.id === id ? { ...m, x, y } : m));
            };
            const updateModuleSize = (id, w, h) => {
                setModules(prev => prev.map(m => m.id === id ? { ...m, w, h } : m));
            };
            const bringToFront = (id) => {
                setModules(prev => {
                    const maxZ = Math.max(...prev.map(m => m.z), 10);
                    return prev.map(m => m.id === id ? { ...m, z: maxZ + 1 } : m);
                });
            };

            const renderModule = (item) => {
                const allUpcoming = [
                    ...(data?.events || []).map(e => ({ ...e, type: 'event', title: e.name, subtitle: 'Event' })),
                    ...(data?.recordings || []).map(r => ({ ...r, type: 'recording', title: r.project, subtitle: 'Inspelning' }))
                ].sort((a, b) => a.sortDate - b.sortDate);

                switch(item.component) {
                    case 'WeatherModule': return <WeatherModule data={weather} w={item.w} h={item.h} />;
                    case 'ProductionModule': return <ProductionModule stats={data?.stats} recent={data?.recentDeliveries} loading={loading} h={item.h/100} />;
                    case 'SlideshowModule': return <SlideshowModule customImages={images} />;
                    case 'TimelineModule': return <TimelineModule items={allUpcoming} loading={loading} />;
                    case 'BirthdaysModule': return <BirthdaysModule birthdays={data?.birthdays} />;
                    default: return null;
                }
            };

            // --- LOCAL IMAGE SCANNER ---
            const scanLocalImages = async () => {
                const candidates = [];
                // Letar efter 1.jpg -> 20.jpg, png, jpeg, webp
                for (let i = 1; i <= 20; i++) {
                    candidates.push(`bilder/${i}.jpg`);
                    candidates.push(`bilder/${i}.png`);
                    candidates.push(`bilder/${i}.jpeg`);
                    candidates.push(`bilder/${i}.webp`);
                }
                const valid = [];
                for (const src of candidates) {
                    try {
                        const res = await new Promise((resolve) => {
                            const img = new Image();
                            img.onload = () => resolve(src);
                            img.onerror = () => resolve(null);
                            img.src = src;
                        });
                        if (res) valid.push(res);
                    } catch(e) {}
                }
                return valid;
            };

            useEffect(() => {
                const timer = setInterval(() => setTime(new Date()), 1000);
                const fetchData = async () => {
                    setLoading(true);
                    const weatherData = await fetchOpenMeteoData();
                    try {
                        const clickUpData = await getClickUpData();
                        const sheetData = await getGoogleSheetEvents();
                        
                        setData({ ...clickUpData, events: sheetData.events });
                        
                        // Endast lokala bilder
                        const locals = await scanLocalImages();
                        setImages(locals);
                        
                        if(weatherData) setWeather(weatherData);
                    } catch(e) {}
                    setLoading(false);
                };
                fetchData();
                const interval = setInterval(() => {
                    const now = new Date();
                    const h = now.getHours().toString().padStart(2,'0');
                    const m = now.getMinutes().toString().padStart(2,'0');
                    const currentTime = `${h}:${m}`;
                    if (UPDATE_SCHEDULE.includes(currentTime)) fetchData();
                }, 60000);
                return () => { clearInterval(timer); clearInterval(interval); };
            }, []);

            const timeStr = time.toLocaleTimeString('sv-SE', { hour: '2-digit', minute: '2-digit' });
            const dateStr = time.toLocaleDateString('sv-SE', { weekday: 'long', day: 'numeric', month: 'long' });

            return (
                <div className="min-h-screen w-full h-screen relative overflow-hidden bg-black">
                    <header className="absolute top-0 left-0 right-0 p-8 flex justify-between items-end z-0 pointer-events-none h-[180px]">
                         <div className="flex flex-col">
                             <div className="flex items-center gap-4 mb-3">
                                <img src={LOGO_SYMBOL} alt="Crisp" className="h-16 w-auto object-contain" onError={(e) => e.target.style.display = 'none'}/>
                                <img src={LOGO_TEXT} alt="Crisp Film" className="h-8 w-auto object-contain mt-2" onError={(e) => e.target.style.display = 'none'}/>
                             </div>
                             <div className="hidden"><h1 className="text-7xl font-bold tracking-tighter text-white leading-none mb-2">Going on at Crisp</h1></div>
                            <p className="text-slate-400 text-2xl font-medium tracking-wide uppercase opacity-80">We make brands stronger through film</p>
                        </div>
                        <div className="text-right">
                            <div className="text-9xl font-semibold text-white tracking-tighter leading-none">{timeStr}</div>
                            <div className="text-slate-400 text-3xl capitalize font-medium mt-2">{dateStr}</div>
                        </div>
                    </header>

                    <div className="absolute inset-0 z-10">
                        {modules.map(m => (
                            <SmartTile 
                                key={m.id} 
                                {...m} 
                                allModules={modules}
                                onMove={updateModulePos} 
                                onResize={updateModuleSize}
                                onSelect={bringToFront}
                            >
                                {renderModule(m)}
                            </SmartTile>
                        ))}
                    </div>
                </div>
            );
        };

        // --- API & LOGIK ---
        const fetchOpenMeteoData = async () => {
                try {
                    const res = await fetch("https://api.open-meteo.com/v1/forecast?latitude=59.3293&longitude=18.0686&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m&hourly=temperature_2m,weather_code&daily=weather_code,temperature_2m_max&timezone=Europe%2FBerlin");
                    const json = await res.json();
                    const getCondition = (code) => {
                        if (code === 0) return "Soligt"; if (code <= 3) return "Molnigt";
                        if (code <= 48) return "Dimma"; if (code <= 67) return "Regn";
                        if (code <= 77) return "SnÃ¶"; return "Ostadigt";
                    };
                    const current = {
                        temp: json.current.temperature_2m, feelsLike: json.current.apparent_temperature,
                        wind: json.current.wind_speed_10m, humidity: json.current.relative_humidity_2m,
                        condition: getCondition(json.current.weather_code), code: json.current.weather_code
                    };
                    const hourly = []; const nowHour = new Date().getHours();
                    [1, 4, 7].forEach(offset => {
                        const idx = nowHour + offset;
                        if (idx < 24) { hourly.push({ time: `${idx}:00`, temp: json.hourly.temperature_2m[idx], code: json.hourly.weather_code[idx] }); }
                    });
                    const daysMap = ['SÃ¶n', 'MÃ¥n', 'Tis', 'Ons', 'Tor', 'Fre', 'LÃ¶r'];
                    const forecast = [];
                    for(let i=1; i<=3; i++) {
                        const d = new Date(); d.setDate(d.getDate() + i);
                        forecast.push({ day: daysMap[d.getDay()], temp: json.daily.temperature_2m_max[i], code: json.daily.weather_code[i] });
                    }
                    return { ...current, hourly, forecast };
                } catch(e) { return null; }
            };

        async function getGoogleSheetEvents() {
            if (!GOOGLE_SHEET_CSV_URL) return { events: [] };
            try {
                const url = `${GOOGLE_SHEET_CSV_URL}&t=${Date.now()}`;
                const res = await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`);
                if (!res.ok) return { events: [] };
                const txt = await res.text();
                const rows = txt.split(/\r\n|\n/);
                const events = [];
                const yest = new Date(); yest.setDate(yest.getDate()-1); yest.setHours(0,0,0,0);
                
                const parseDateRobustly = (dateStr) => {
                    if (!dateStr) return null;
                    let cleanStr = dateStr.trim();
                    let d = new Date(cleanStr);
                    if (!isNaN(d.getTime())) return d;
                    cleanStr = cleanStr.split(' ')[0];
                    d = new Date(cleanStr);
                    if (!isNaN(d.getTime())) return d;
                    return null;
                };

                rows.forEach((row, i) => {
                    if(i===0) return;
                    const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                    if(cols.length < 3) return; 
                    const name = cols[2].replace(/^"|"$/g, '').trim();
                    const dateStr = cols[3].replace(/^"|"$/g, '').trim();
                    if(name && dateStr) {
                        const d = parseDateRobustly(dateStr);
                        if(d && d >= yest) {
                            events.push({
                                name, sortDate: d.getTime(),
                                dateMain: d.getDate(),
                                dateSub: d.toLocaleDateString('sv-SE', {month:'short'}).toUpperCase()
                            });
                        }
                    }
                });
                return { events }; 
            } catch(e) { return { events: [] }; }
        }

        async function getClickUpData() {
            if (!CLICKUP_SPACE_ID) return {};
            const headers = { 'Authorization': CLICKUP_API_TOKEN };
            const proxy = "https://corsproxy.io/?";
            try {
                const teamRes = await fetch(`${proxy}https://api.clickup.com/api/v2/team`, { headers });
                const teamId = (await teamRes.json()).teams[0].id;
                
                const getAllTasks = async (archived) => {
                    let all = []; let page = 0;
                    while(page < 40) {
                        try {
                            const url = `${proxy}https://api.clickup.com/api/v2/team/${teamId}/task?space_ids[]=${CLICKUP_SPACE_ID}&archived=${archived}&include_closed=true&subtasks=true&limit=100&date_updated_gt=${START_DATE_TIMESTAMP}&page=${page}`;
                            const res = await fetch(url, { headers });
                            const json = await res.json();
                            if(!json.tasks || json.tasks.length === 0) break;
                            all = [...all, ...json.tasks];
                            page++;
                        } catch(e) { break; }
                    }
                    return all;
                };

                const getProjectTasks = async () => {
                    let all = []; let page = 0;
                    if (!CLICKUP_PROJECTS_LIST_ID) return [];
                    while(page < 5) {
                         try {
                            const url = `${proxy}https://api.clickup.com/api/v2/list/${CLICKUP_PROJECTS_LIST_ID}/task?include_closed=true&date_updated_gt=${START_DATE_TIMESTAMP}&page=${page}`;
                            const res = await fetch(url, { headers });
                            const json = await res.json();
                            if(!json.tasks || json.tasks.length === 0) break;
                            all = [...all, ...json.tasks];
                            page++;
                         } catch(e) { break; }
                    }
                    return all;
                };

                const [active, archived, projects] = await Promise.all([getAllTasks(false), getAllTasks(true), getProjectTasks()]);
                const tasksMap = new Map(); [...active, ...archived].forEach(t => tasksMap.set(t.id, t));
                let tasks = Array.from(tasksMap.values()).filter(t => {
                     const folderName = t.folder ? t.folder.name : "";
                     const listName = t.list ? t.list.name : "";
                     return folderName.startsWith("25") || listName.startsWith("25");
                });

                const validProjects = projects.filter(t => t.name.startsWith("25"));
                const activeProjects = validProjects.filter(t => t.status.status.toLowerCase() === 'production').length;
                const totalProjects2025 = validProjects.filter(t => {
                    const s = t.status.status.toLowerCase();
                    return s === 'production' || s === 'delivered';
                }).length;

                const recTasks = tasks.filter(t => t.name.trim().toLowerCase() === "inspelning");
                const upcomingRec = recTasks
                    .filter(t => {
                        const d = parseInt(t.start_date||t.due_date||0);
                        const s = t.status.status.toLowerCase();
                        return d >= Date.now() - 86400000 && s!=='complete' && s!=='closed' && s!=='klar' && s!=='done';
                    })
                    .sort((a,b) => (a.start_date||0) - (b.start_date||0));
                const seen = new Set(); const finalRec = [];
                for(const t of upcomingRec) {
                    let n = "Projekt";
                    if(t.folder) n = t.folder.name; else if(t.list) n = t.list.name;
                    n = n.length > 6 && n.includes('_') ? n.substring(6).replace(/_/g,' ') : n;
                    if(!seen.has(n)) {
                        seen.add(n);
                        const d = parseInt(t.start_date||t.due_date);
                        finalRec.push({
                            id: t.id, project: n, sortDate: d,
                            dateMain: new Date(d).getDate(),
                            dateSub: new Date(d).toLocaleDateString('sv-SE',{month:'short'}).toUpperCase()
                        });
                    }
                    if(finalRec.length >= 5) break;
                }

                const delTasks = tasks.filter(t => {
                    const n = t.name.toLowerCase();
                    const s = t.status.status.toLowerCase();
                    return n.includes("leverans") && !n.includes("inspelning") && (s==='complete'||s==='closed'||s==='done'||s==='klar');
                });
                const recentDel = delTasks
                    .sort((a,b) => parseInt(b.date_closed||0) - parseInt(a.date_closed||0))
                    .slice(0,5)
                    .map(t => {
                        let n = "Projekt";
                        if(t.folder) n = t.folder.name; else if(t.list) n = t.list.name;
                        n = n.length > 6 && n.includes('_') ? n.substring(6).replace(/_/g,' ') : n;
                        const ts = parseInt(t.date_closed||t.date_updated||0);
                        return { name: n, date: ts > 0 ? new Date(ts).toLocaleDateString('sv-SE',{day:'numeric', month:'short'}) : "-" };
                    });
                let birthdays = [];
                if(CLICKUP_BIRTHDAY_LIST_ID) {
                     try {
                        const bdRes = await fetch(`${proxy}https://api.clickup.com/api/v2/list/${CLICKUP_BIRTHDAY_LIST_ID}/task`, { headers });
                        const bdJson = await bdRes.json();
                        birthdays = (bdJson.tasks || [])
                            .map(t => {
                                const d = new Date(parseInt(t.due_date));
                                const today = new Date();
                                let next = new Date(today.getFullYear(), d.getMonth(), d.getDate());
                                if(next < today) next.setFullYear(today.getFullYear()+1);
                                const diff = Math.ceil((next - today)/(1000*60*60*24));
                                return { name: t.name, dateStr: next.toLocaleDateString('sv-SE', {day:'numeric', month:'short'}), diff, isSoon: diff < 14 };
                            })
                            .filter(b => b.diff < 40)
                            .sort((a,b) => a.diff - b.diff)
                            .slice(0,3);
                    } catch(e) {}
                }
                return {
                    stats: { 
                        year: delTasks.length, 
                        occasions: recTasks.length,
                        activeProjects: activeProjects,
                        totalProjects2025: totalProjects2025
                    },
                    recordings: finalRec,
                    recentDeliveries: recentDel,
                    birthdays: birthdays
                };
            } catch(e) { return {}; }
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>